<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ELOS FORTE INVESTIMENTOS</title>

<style>
/* --- MANTIDO EXATAMENTE COMO O SEU DESIGN ORIGINAL --- */
:root{
  --bg:#0f172a; --panel:#111827; --soft:#1f2937; --muted:#334155;
  --accent:#22c55e; --danger:#ef4444; --warn:#f59e0b; --text:#e5e7eb;
  --sub:#94a3b8; --card:#0b1223; --shadow: 0 10px 30px rgba(0,0,0,.35);
  --radius: 18px;
}
*{box-sizing:border-box}
body{
  margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto;
  background: radial-gradient(1200px 600px at 10% -10%, #1e293b 10%, transparent 60%),
              radial-gradient(1000px 500px at 110% 10%, #0b1223 10%, transparent 60%),
              var(--bg);
  color:var(--text); min-height:100dvh;
}
.container{max-width:1200px; margin:0 auto; padding:16px}
h1{margin:6px 0 2px; font-size:24px; letter-spacing:.3px; text-align:center;}
.mono{font-family:ui-monospace,Menlo,Consolas,monospace}
.muted{color:#9aa8bf}
.val-in{ color: var(--accent); }
.val-out{ color: var(--danger); }

header{
  position:sticky; top:0; z-index:10; backdrop-filter: blur(8px);
  background:linear-gradient(180deg, rgba(2,6,23,.85), rgba(2,6,23,.55));
  border-bottom:1px solid #1f2937; box-shadow: var(--shadow);
}
header .container{ display:flex; flex-direction:column; align-items:center; }

header nav{ display:flex; gap:8px; flex-wrap:wrap; margin:12px 0; }
header .logo{ width:300px; margin:6px auto 4px; filter: drop-shadow(0 6px 16px rgba(0,0,0,.35)); }
.subtitle{ color:var(--sub); font-size:12px; }

.tab-btn{
  padding:10px 14px; border:1px solid #273548; border-radius:999px;
  background:#0b1223; color:#cbd5e1; cursor:pointer;
}
.tab-btn.active{
  background:linear-gradient(90deg,#16a34a,#22c55e);
  color:#000; border-color:transparent;
}

.card{
  background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,0));
  border:1px solid #223047; border-radius: var(--radius);
  padding:16px; margin-top:16px; box-shadow: var(--shadow);
}
.row{display:flex; gap:12px; flex-wrap:wrap}

input,select{
  width:100%; padding:10px; border-radius:12px;
  background:#0b1324; border:1px solid #273548; color:#e2e8f0;
}
.btn-primary{
  padding:10px 14px; border:none; border-radius:12px;
  background:linear-gradient(90deg,#16a34a,#22c55e); color:#000; cursor:pointer;
}
.btn-ghost{
  padding:8px 10px; border-radius:10px;
  background:#0b1223; border:1px solid #273548; cursor:pointer; color:#cbd5e1;
}

table{width:100%; border-collapse:collapse; margin-top:10px; font-size:14px;}
th,td{ padding:10px 6px; border-bottom:1px dashed #263448; }
th{text-align:left; color:#a7b3c8;}

footer{
  text-align:center; margin:40px 0; color:#93a1b7;
}

.pill{padding:4px 8px; border-radius:999px; font-size:11px; font-weight:bold;}
.pill.in{background:#052e1a; color:#22c55e;}
.pill.out{background:#3b0a0a; color:#f87171;}

/* Toast */
.toast{
  position:fixed; left:50%; transform:translateX(-50%); bottom:20px;
  background:#0c162b; border:1px solid #223047; padding:10px 16px;
  border-radius:12px; box-shadow:var(--shadow);
}

/* Modal */
#confirmOverlay{
  position:fixed; inset:0; background:rgba(0,0,0,.55);
  display:none; align-items:center; justify-content:center; z-index:50;
}
#confirmBox{
  background:#0b1223; border:1px solid #223047;
  padding:20px; border-radius:14px; width:320px;
}
</style>
</head>


<body>

<header>
  <div class="container">
    <h1><img src="elos_fusao_horizontal_iconOnly_300w.png" class="logo"></h1>

    <div class="subtitle">
      Ciclo atual: <span id="cycleLabel" class="mono"></span> •
      Saldo do Fundo: <span id="saldoFundo" class="mono"></span>
    </div>

    <nav>
      <button class="tab-btn active" data-tab="tab-lancamentos">Lançamentos</button>
      <button class="tab-btn" data-tab="tab-emprestimos">Empréstimos</button>
      <button class="tab-btn" data-tab="tab-retornos">Retornos</button>
      <button class="tab-btn" data-tab="tab-correntistas">Correntistas</button>
      <button class="tab-btn" data-tab="tab-resumo">Resumo</button>
      <button class="tab-btn" data-tab="tab-baixa-final">Baixa Final</button>
      <button class="tab-btn" data-tab="tab-config">Config</button>
    </nav>
  </div>
</header>


<main class="container">

  <!-- KPIs -->
  <section class="card" id="kpis">
    <h2>Indicadores</h2>
    <div class="row">
      <div><b>Total de Cotas:</b> <span id="kpiTotalCotas" class="mono val-in"></span></div>
      <div><b>Passivo 10%:</b> <span id="kpiPassivo10" class="mono muted"></span></div>
      <div><b>Juros Recebidos:</b> <span id="kpiJuros" class="mono val-in"></span></div>
    </div>
  </section>

  <!-- Lançamentos -->
  <section id="tab-lancamentos" class="card">
    <h3>Lançar Cotas</h3>
    <div class="row">
      <label style="flex:1">Correntista
        <select id="cotistaSelect"></select>
      </label>
      <label style="flex:1">Valor
        <input type="number" id="valorCota" step="0.01">
      </label>
      <label style="flex:1">Data
        <input type="date" id="dataCota">
      </label>
    </div>
    <button class="btn-primary" id="btnAddCota">Adicionar</button>

    <table id="tabelaCotas">
      <thead><tr><th>Data</th><th>Correntista</th><th>Valor</th><th>10%</th><th>Ciclo</th><th>Ação</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Empréstimos -->
  <section id="tab-emprestimos" class="card" hidden>
    <h3>Registrar Empréstimo</h3>

    <div class="row">
      <label style="flex:1">Tomador <input id="emprestTomador"></label>
      <label style="flex:1">Principal <input id="emprestPrincipal" type="number"></label>
      <label style="flex:1">Percentual
        <select id="emprestPercentual">
          <option value="0.2">20%</option>
          <option value="0.3">30%</option>
        </select>
      </label>
    </div>

    <div class="row">
      <label style="flex:1">Data <input type="date" id="emprestData"></label>
      <label style="flex:1">Vencimento <input type="date" id="emprestVenc"></label>
      <label style="flex:1">Status
        <select id="emprestStatus">
          <option value="aberto">Aberto</option>
          <option value="fechado">Fechado</option>
        </select>
      </label>
    </div>

    <button class="btn-primary" id="btnAddEmprestimo">Registrar</button>

    <h3>Empréstimos</h3>
    <table id="tabelaEmprestimos">
      <thead>
        <tr><th>Data</th><th>Tomador</th><th>Principal</th><th>%</th><th>Total</th><th>Pago</th><th>Status</th><th>Ação</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <h3>Cashbacks</h3>
    <table id="tabelaCashbacks">
      <thead><tr><th>Tomador</th><th>Cashback</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Retornos -->
  <section id="tab-retornos" class="card" hidden>
    <h3>Registrar Retorno</h3>

    <div class="row">
      <label style="flex:1">Empréstimo <select id="retornoEmprestimo"></select></label>
      <label style="flex:1">Valor <input id="retornoValor" type="number"></label>
      <label style="flex:1">Data <input id="retornoData" type="date"></label>
    </div>

    <div class="row">
      <label style="flex:1">Tipo
        <select id="retornoTipo">
          <option value="misto">Misto</option>
          <option value="principal">Principal</option>
          <option value="juros">Juros</option>
        </select>
      </label>
    </div>

    <button class="btn-primary" id="btnAddRetorno">Registrar</button>

    <table id="tabelaRetornos">
      <thead><tr><th>Data</th><th>Tomador</th><th>Valor</th><th>Tipo</th><th>Emp.</th><th>Ação</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Correntistas -->
  <section id="tab-correntistas" class="card" hidden>
    <h3>Correntistas</h3>
    <button class="btn-primary" id="btnAddPessoa">Adicionar</button>

    <table id="tabelaPessoas">
      <thead>
        <tr><th>#</th><th>Nome</th><th>Total</th><th>10%</th><th>Parcela</th><th>Ação</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Resumo -->
  <section id="tab-resumo" class="card" hidden>
    <h3>Resumo</h3>

    <div class="row">
      <label>De <input type="date" id="filtroDe"></label>
      <label>Até <input type="date" id="filtroAte"></label>
      <label>Tipo
        <select id="filtroTipo">
          <option value="todos">Todos</option>
          <option value="cotas">Cotas</option>
          <option value="emprestimos">Empréstimos</option>
          <option value="retornos">Retornos</option>
          <option value="payouts">Baixas</option>
        </select>
      </label>
    </div>

    <div class="row">
      <label>Tomador <select id="filtroTomador"></select></label>
      <label>Correntista <select id="filtroCorrentista"></select></label>
    </div>

    <button class="btn-primary" id="btnAplicarFiltros">Aplicar</button>
    <button class="btn-ghost" id="btnLimparFiltros">Limpar</button>

    <table id="tabelaMovimentos">
      <thead><tr><th>Data</th><th>Tipo</th><th>Descrição</th><th>Valor</th></tr></thead>
      <tbody></tbody>
    </table>

    <ul id="totaisPeriodo"></ul>
  </section>

  <!-- Baixa Final -->
  <section id="tab-baixa-final" class="card" hidden>
    <h3>Baixa Final</h3>

    <label>Ciclo <select id="cicloPayout"></select></label>
    <button class="btn-primary" id="btnGerarPayout">Gerar</button>

    <table id="tabelaPayouts">
      <thead><tr><th>Correntista</th><th>Total</th><th>10%</th><th>Devolver</th><th>Ação</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Config -->
  <section id="tab-config" class="card" hidden>
    <h3>Configurações</h3>

    <div class="row">
      <label>Início <input type="month" id="cfgInicio"></label>
      <label>Fim <input type="month" id="cfgFim"></label>
    </div>

    <button class="btn-primary" id="btnSalvarCfg">Salvar Ciclo</button>

    <h3>Backup</h3>
    <button id="btnExportarBackup" class="btn-ghost">Exportar JSON</button>
    <button id="btnImportarBackup" class="btn-ghost">Importar JSON</button>
    <input id="inputImportBackup" type="file" hidden>

  </section>

</main>

<footer>
  Plataforma © 2025 — Gestão clara. Desenvolvido por Marcelo.
</footer>


<!-- Modal -->
<div id="confirmOverlay">
  <div id="confirmBox">
    <div id="confirmTitle">Confirmar</div>
    <p id="confirmText">Deseja executar esta ação?</p>
    <button id="confirmYes" class="btn-primary">Sim</button>
    <button id="confirmNo" class="btn-ghost">Não</button>
  </div>
</div>


<!-- ============================================== -->
<!-- SCRIPTS COMPLETOS (Partes 3.1 + 3.2 + 3.3 + 3.4) -->
<!-- ============================================== -->

<script>
/* ================================================
   UTILS, STATE, CALC  (PARTE 3.1)
================================================ */
const BRL = new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"});
const fmt = n => BRL.format(Number(n||0));
const uid = () => Date.now().toString(36)+Math.random().toString(36).slice(2,7);
const today = () => new Date().toISOString().slice(0,10);
const monthStr = d => (d||"").slice(0,7);
function addMonths(d,m=1){ const x=new Date(d||today()); x.setMonth(x.getMonth()+m); return x.toISOString().slice(0,10); }

const KEY="plataforma_cotas_v2";
const state=JSON.parse(localStorage.getItem(KEY)||"null")||{
 config:{inicio:"2024-12",fim:"2025-11"},
 pessoas:[],cotas:[],emprestimos:[],retornos:[],payouts:[],cashbacks:[],
 seqEmprestimo:1,lock:{pin:"",locked:false}
};

if(!Array.isArray(state.cashbacks)) state.cashbacks=[];
if(!state.lock) state.lock={pin:"",locked:false};
if(typeof state.seqEmprestimo!=="number") state.seqEmprestimo=1;

function save(){ localStorage.setItem(KEY,JSON.stringify(state)); renderAll(); }

/* CALCULOS */
function cicloDeData(data){
  const m=monthStr(data), ini=state.config.inicio, fim=state.config.fim;
  if(m>=ini && m<=fim) return ini+"→"+fim;
  return m;
}
function jurosDoEmprestimo(e){ return Number(e.principal)*Number(e.percentual); }
function devidoEmprestimo(e){
  const juros=jurosDoEmprestimo(e);
  const total=Number(e.principal)+juros+Number(e.extra||0);
  const pagos=state.retornos.filter(r=>r.emprestimoId===e.id).reduce((s,r)=>s+Number(r.valor),0);
  return{ total, pagos, aberto: pagos+0.01<total };
}
function totalCotas(c){ return state.cotas.filter(x=>!c||x.ciclo===c).reduce((s,x)=>s+Number(x.valor),0); }
function passivo10(c){ 
  const base=totalCotas(c)*0.10;
  const pagos=state.payouts.filter(p=>!c||p.ciclo===c).reduce((s,p)=>s+Number(p.valor)/11,0);
  return Math.max(0,base-pagos);
}
function jurosRecebidos(){
  return state.retornos.filter(r=>r.tipo!=="principal").reduce((s,r)=>s+Number(r.valor),0);
}
function totalEmprestimosLiberados(){ return state.emprestimos.reduce((s,e)=>s+Number(e.principal),0); }
function totalRetornos(){ return state.retornos.reduce((s,r)=>s+Number(r.valor),0); }
function totalPayouts(){ return state.payouts.reduce((s,p)=>s+Number(p.valor),0); }
function saldoFundo(){ return totalCotas()+totalRetornos()-totalEmprestimosLiberados()-totalPayouts(); }


/* ================================================
   RENDER  (PARTE 3.2)
================================================ */
function setText(id, t){ const el=document.getElementById(id); if(el) el.textContent=t; }
function clear(e){ while(e.firstChild) e.removeChild(e.firstChild); }
function empShortId(e){ const m=(e.codigo||"").match(/(\d+)/); return m?m[1]:e.codigo; }

function renderHeader(){
  setText("cycleLabel", state.config.inicio+"→"+state.config.fim);
  setText("saldoFundo", fmt(saldoFundo()));
}
function renderKPIs(){
  const ciclo=state.config.inicio+"→"+state.config.fim;
  setText("kpiTotalCotas", fmt(totalCotas(ciclo)));
  setText("kpiPassivo10", fmt(passivo10(ciclo)));
  setText("kpiJuros", fmt(jurosRecebidos()));
}

function renderCotas(){
  const sel=document.getElementById("cotistaSelect");
  const tb=document.querySelector("#tabelaCotas tbody");
  clear(sel); clear(tb);

  state.pessoas.forEach(p=>{
    const o=document.createElement("option"); o.value=p.id; o.textContent=p.nome;
    sel.appendChild(o);
  });
  if(!document.getElementById("dataCota").value)
    document.getElementById("dataCota").value=today();

  const filtroId=sel.value;
  state.cotas
   .filter(c=>!filtroId||c.pessoaId===filtroId)
   .sort((a,b)=>a.data.localeCompare(b.data))
   .forEach(c=>{
     const p=state.pessoas.find(x=>x.id===c.pessoaId);
     const tr=document.createElement("tr");
     tr.innerHTML=`
       <td>${c.data}</td><td>${p?p.nome:"—"}</td>
       <td class="val-in">${fmt(c.valor)}</td>
       <td class="muted">${fmt(c.valor*0.10)}</td>
       <td class="muted">${c.ciclo}</td>
       <td><button class="btn-ghost" data-del-cota="${c.id}">Excluir</button></td>`;
     tb.appendChild(tr);
   });
}

function renderEmprestimos(){
  const tb=document.querySelector("#tabelaEmprestimos tbody");
  const selRet=document.getElementById("retornoEmprestimo");
  clear(tb); clear(selRet);

  state.emprestimos.sort((a,b)=>a.data.localeCompare(b.data)).forEach(e=>{
    const d=devidoEmprestimo(e);
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${e.data}</td>
      <td>${e.tomador}<div class="muted mono">${e.codigo} • Venc.: ${e.vencimento}</div></td>
      <td class="val-out">${fmt(e.principal)}</td>
      <td>${Math.round(e.percentual*100)}%</td>
      <td>${fmt(d.total)}</td>
      <td class="${d.pagos+0.009>=d.total?"val-in":""}">${fmt(d.pagos)}</td>
      <td>${d.aberto?'<span class="pill out">Aberto</span>':'<span class="pill in">Fechado</span>'}</td>
      <td>
        <button class="btn-ghost" data-close-emp="${e.id}">${d.aberto?"Fechar":"Reabrir"}</button>
        <button class="btn-ghost" data-del-emp="${e.id}">Excluir</button>
      </td>`;
    tb.appendChild(tr);
  });

  state.emprestimos.forEach(e=>{
    const d=devidoEmprestimo(e);
    if(!d.aberto) return;
    const o=document.createElement("option");
    o.value=e.id;
    o.textContent=`ID ${empShortId(e)} • ${e.tomador} • ${fmt(e.principal)} • Devido ${fmt(d.total-d.pagos)}`;
    selRet.appendChild(o);
  });

  if(!selRet.options.length){
    const o=document.createElement("option");
    o.textContent="— nenhum empréstimo aberto —";
    selRet.appendChild(o);
  }
}

function renderCashbacks(){
  const tb=document.querySelector("#tabelaCashbacks tbody");
  clear(tb);
  if(!state.cashbacks.length){
    tb.innerHTML='<tr><td colspan="2" class="muted">Nenhum cashback.</td></tr>';
    return;
  }
  const map={};
  state.cashbacks.forEach(cb=>{
    map[cb.tomador]=(map[cb.tomador]||0)+Number(cb.valor);
  });
  Object.keys(map).sort().forEach(n=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${n}</td><td class="val-in">${fmt(map[n])}</td>`;
    tb.appendChild(tr);
  });
}

function renderRetornos(){
  const tb=document.querySelector("#tabelaRetornos tbody");
  clear(tb);
  state.retornos.sort((a,b)=>a.data.localeCompare(b.data)).forEach(r=>{
    const e=state.emprestimos.find(x=>x.id===r.emprestimoId);
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${r.data}</td><td>${e?e.tomador:"—"}</td>
      <td class="val-in">${fmt(r.valor)}</td>
      <td>${r.tipo}</td>
      <td class="muted">${e?"ID "+empShortId(e):"—"}</td>
      <td><button class="btn-ghost" data-del-ret="${r.id}">Excluir</button></td>`;
    tb.appendChild(tr);
  });
}

function renderPessoas(){
  const tb=document.querySelector("#tabelaPessoas tbody");
  clear(tb);
  const ciclo=state.config.inicio+"→"+state.config.fim;

  state.pessoas.forEach((p,i)=>{
    const tot=state.cotas.filter(c=>c.pessoaId===p.id&&c.ciclo===ciclo).reduce((s,c)=>s+Number(c.valor),0);
    const qtd=state.cotas.filter(c=>c.pessoaId===p.id&&c.ciclo===ciclo).length;
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${i+1}</td>
      <td><input data-pessoa-nome="${p.id}" value="${p.nome}"></td>
      <td class="val-in">${fmt(tot)}</td>
      <td class="muted">${fmt(tot*0.10)}</td>
      <td class="muted">${Math.min(qtd,12)}/12</td>
      <td><button class="btn-ghost" data-del-pessoa="${p.id}">Remover</button></td>`;
    tb.appendChild(tr);
  });
}

let lastResumoRows=[];
function populateFilterCombos(){
  const tSel=document.getElementById("filtroTomador");
  const cSel=document.getElementById("filtroCorrentista");
  const setT=new Set(state.emprestimos.map(e=>e.tomador));
  const setC=new Set(state.pessoas.map(p=>p.nome));

  function fill(sel,items){
    const cur=sel.value||"todos";
    sel.innerHTML=`<option value="todos">Todos</option>`;
    [...items].sort().forEach(v=>{
      const o=document.createElement("option"); o.value=v; o.textContent=v; sel.appendChild(o);
    });
    sel.value=cur;
  }
  fill(tSel,setT); fill(cSel,setC);
}

function aplicarFiltros(){
  const de=document.getElementById("filtroDe").value||"0000-01-01";
  const ate=document.getElementById("filtroAte").value||"9999-12-31";
  const tipo=document.getElementById("filtroTipo").value;
  const tomSel=document.getElementById("filtroTomador").value;
  const corSel=document.getElementById("filtroCorrentista").value;

  const rows=[];
  let totIn=0, totOut=0;

  if(["todos","cotas"].includes(tipo)){
    state.cotas.forEach(c=>{
      const p=state.pessoas.find(x=>x.id===c.pessoaId);
      if(c.data<de||c.data>ate) return;
      if(corSel!=="todos" && p?.nome!==corSel) return;
      rows.push({data:c.data,tipo:"Cota",desc:p?.nome||"—",valor:Number(c.valor)});
      totIn+=Number(c.valor);
    });
  }

  if(["todos","emprestimos","emp_vencidos","emp_avencer"].includes(tipo)){
    const hoje=today();
    state.emprestimos.forEach(e=>{
      const venc=e.vencimento||e.data;
      const d=devidoEmprestimo(e);
      const aberto=d.aberto;
      const vencido=aberto && venc<hoje;
      const avencer=aberto && !vencido && (new Date(venc)-new Date(hoje)<=7*86400*1000);

      let dentro=false;
      if(tipo==="emprestimos") dentro=e.data>=de&&e.data<=ate;
      if(tipo==="emp_vencidos") dentro=vencido&&venc>=de&&venc<=ate;
      if(tipo==="emp_avencer") dentro=avencer&&venc>=de&&venc<=ate;
      if(tipo==="todos") dentro=e.data>=de&&e.data<=ate;

      if(!dentro) return;
      if(tomSel!=="todos" && e.tomador!==tomSel) return;

      rows.push({
        data:(tipo==="emp_vencidos"||tipo==="emp_avencer")?venc:e.data,
        tipo: tipo==="emp_vencidos"?"Empréstimo (Vencido)":
              tipo==="emp_avencer"?"Empréstimo (A vencer)":"Empréstimo",
        desc:`ID ${empShortId(e)} • ${e.tomador}`,
        valor:-Number(e.principal)
      });
      totOut+=Number(e.principal);
    });
  }

  if(["todos","retornos"].includes(tipo)){
    state.retornos.forEach(r=>{
      if(r.data<de||r.data>ate) return;
      const e=state.emprestimos.find(x=>x.id===r.emprestimoId);
      if(tomSel!=="todos" && e?.tomador!==tomSel) return;
      rows.push({
        data:r.data,
        tipo:`Retorno ${r.tipo}`,
        desc:e?`ID ${empShortId(e)} • ${e.tomador}`:"—",
        valor:Number(r.valor)
      });
      totIn+=Number(r.valor);
    });
  }

  if(["todos","payouts"].includes(tipo)){
    state.payouts.forEach(p=>{
      if(p.data<de||p.data>ate) return;
      const pes=state.pessoas.find(x=>x.id===p.pessoaId);
      rows.push({data:p.data,tipo:"Baixa Final",desc:pes?.nome||"—",valor:-Number(p.valor)});
      totOut+=Number(p.valor);
    });
  }

  rows.sort((a,b)=>a.data.localeCompare(b.data));
  lastResumoRows=rows.slice();

  const tb=document.querySelector("#tabelaMovimentos tbody");
  clear(tb);
  rows.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${r.data}</td><td>${r.tipo}</td><td>${r.desc}</td>
      <td class="${r.valor>=0?"val-in":"val-out"}">${fmt(r.valor)}</td>`;
    tb.appendChild(tr);
  });

  document.getElementById("totaisPeriodo").innerHTML=`
    <li>Entradas: <b>${fmt(totIn)}</b></li>
    <li>Saídas: <b>${fmt(totOut)}</b></li>
    <li>Saldo Líquido: <b>${fmt(totIn-totOut)}</b></li>`;
}

function renderCiclosPayout(){
  const sel=document.getElementById("cicloPayout");
  clear(sel);
  const set=new Set(state.cotas.map(c=>c.ciclo));
  if(!set.size){ sel.innerHTML='<option>—</option>'; return; }
  [...set].forEach(c=>{
    const o=document.createElement("option"); o.value=o.textContent=c; sel.appendChild(o);
  });
}
function getPayoutRows(ciclo){
  const map=new Map();
  state.cotas.filter(c=>c.ciclo===ciclo).forEach(c=>{
    map.set(c.pessoaId,(map.get(c.pessoaId)||0)+Number(c.valor));
  });
  const rows=[];
  state.pessoas.forEach(p=>{
    const tot=map.get(p.id)||0; if(!tot) return;
    const dez=tot*0.10, dev=tot+dez;
    rows.push({pessoaId:p.id,nome:p.nome,total:tot,dez,devolver:dev});
  });
  return rows;
}
function gerarTabelaPayout(){
  const ciclo=document.getElementById("cicloPayout").value;
  const tb=document.querySelector("#tabelaPayouts tbody");
  clear(tb);
  getPayoutRows(ciclo).forEach(r=>{
    const pago=state.payouts.some(x=>x.pessoaId===r.pessoaId && x.ciclo===ciclo);
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${r.nome} ${pago?'<span class="pill in">PAGO</span>':''}</td>
      <td class="val-in">${fmt(r.total)}</td>
      <td class="muted">${fmt(r.dez)}</td>
      <td class="val-out"><b>${fmt(r.devolver)}</b></td>
      <td>${
        pago
         ? `<button class="btn-ghost" data-estornar="${r.pessoaId}::${ciclo}">Estornar</button>`
         : `<button class="btn-primary" data-payout="${r.pessoaId}::${ciclo}::${r.devolver}">Registrar</button>`
      }</td>`;
    tb.appendChild(tr);
  });
}

function renderAll(){
  renderHeader();
  renderKPIs();
  renderCotas();
  renderEmprestimos();
  renderCashbacks();
  renderRetornos();
  renderPessoas();
  renderCiclosPayout();
  populateFilterCombos();
}


/* =====================================================
   EVENTS  (PARTE 3.3)
===================================================== */
function ensureNotLocked(){
  if(state.lock?.locked){
    alert("Painel bloqueado por PIN.");
    return false;
  }
  return true;
}

document.addEventListener("click", async e=>{
  const t=e.target;

  if(t.id==="btnAddCota"){
    if(!ensureNotLocked())return;
    const pessoaId=document.getElementById("cotistaSelect").value;
    const valor=Number(document.getElementById("valorCota").value||0);
    const data=document.getElementById("dataCota").value||today();
    if(!pessoaId||valor<=0){ alert("Informe correntista e valor."); return; }
    state.cotas.push({id:uid(),pessoaId,valor,data,ciclo:cicloDeData(data)});
    save(); showToast("Cota registrada.");
  }

  if(t.dataset.delCota){
    if(!ensureNotLocked())return;
    if(!confirm("Excluir esta cota?"))return;
    state.cotas=state.cotas.filter(x=>x.id!==t.dataset.delCota);
    save(); showToast("Cota excluída.",true);
  }

  if(t.id==="btnAddEmprestimo"){
    if(!ensureNotLocked())return;
    const tomador=document.getElementById("emprestTomador").value.trim();
    const principal=Number(document.getElementById("emprestPrincipal").value||0);
    const perc=Number(document.getElementById("emprestPercentual").value);
    const data=document.getElementById("emprestData").value||today();
    let venc=document.getElementById("emprestVenc").value;
    if(!tomador||principal<=0){ alert("Dados inválidos.");return; }
    if(!venc) venc=addMonths(data,1);
    const idEmp=uid();
    state.emprestimos.push({
      id:idEmp,codigo:"EMP-"+String(state.seqEmprestimo++).padStart(4,"0"),
      tomador,principal,percentual:perc,data,vencimento:venc,status:"aberto",extra:0
    });
    if(principal>250){
      state.cashbacks.push({id:uid(),emprestimoId:idEmp,tomador,valor:(principal*0.05).toFixed(2),data});
      showToast("Cashback gerado.");
    }
    save();
  }

  if(t.dataset.closeEmp){
    const eObj=state.emprestimos.find(e=>e.id===t.dataset.closeEmp);
    if(eObj){ eObj.status=eObj.status==="aberto"?"fechado":"aberto"; save(); }
  }

  if(t.dataset.delEmp){
    if(!ensureNotLocked())return;
    if(!confirm("Excluir empréstimo?"))return;
    const id=t.dataset.delEmp;
    state.emprestimos=state.emprestimos.filter(e=>e.id!==id);
    state.retornos=state.retornos.filter(r=>r.emprestimoId!==id);
    state.cashbacks=state.cashbacks.filter(c=>c.emprestimoId!==id);
    save(); showToast("Empréstimo removido.",true);
  }

  if(t.id==="btnAddRetorno"){
    if(!ensureNotLocked())return;
    const empId=document.getElementById("retornoEmprestimo").value;
    const valor=Number(document.getElementById("retornoValor").value||0);
    const data=document.getElementById("retornoData").value||today();
    const tipo=document.getElementById("retornoTipo").value;

    const emp=state.emprestimos.find(e=>e.id===empId);
    if(!emp||valor<=0){ alert("Dados inválidos.");return; }

    const dAntes=devidoEmprestimo(emp);
    const juros=jurosDoEmprestimo(emp);

    if(tipo==="juros"){
      state.retornos.push({id:uid(),emprestimoId:empId,valor,data,tipo:"juros"});
      if(valor+0.009>=juros){
        emp.vencimento=addMonths(data,1);
        emp.status="aberto";
      }
      save(); showToast("Juros registrado."); return;
    }

    if(tipo==="principal"){
      state.retornos.push({id:uid(),emprestimoId:empId,valor,data,tipo:"principal"});
      const restante=dAntes.total-(dAntes.pagos+valor);
      if(restante>0){
        emp.extra+=restante*emp.percentual;
        emp.vencimento=addMonths(data,1);
        emp.status="aberto";
      }else{
        emp.status="fechado"; emp.vencimento=data;
      }
      save(); showToast("Principal registrado."); return;
    }

    if(tipo==="misto"){
      const jurosPag=Math.min(valor,juros);
      const princPag=Math.max(0,valor-jurosPag);
      if(jurosPag>0) state.retornos.push({id:uid(),emprestimoId:empId,valor:jurosPag,data,tipo:"juros"});
      if(princPag>0) state.retornos.push({id:uid(),emprestimoId:empId,valor:princPag,data,tipo:"principal"});
      const restante=dAntes.total-(dAntes.pagos+valor);
      if(restante>0){
        emp.extra+=restante*emp.percentual;
        emp.vencimento=addMonths(data,1);
        emp.status="aberto";
      }else{
        emp.status="fechado"; emp.vencimento=data;
      }
      save(); showToast("Retorno registrado.");
    }
  }

  if(t.dataset.delRet){
    if(!ensureNotLocked())return;
    if(!confirm("Excluir retorno?"))return;
    state.retornos=state.retornos.filter(r=>r.id!==t.dataset.delRet);
    save(); showToast("Retorno excluído.",true);
  }

  if(t.id==="btnAddPessoa"){
    state.pessoas.push({id:uid(),nome:"Novo Nome"});
    save(); showToast("Correntista adicionado.");
  }

  if(t.dataset.delPessoa){
    if(!ensureNotLocked())return;
    if(!confirm("Excluir correntista?"))return;
    const id=t.dataset.delPessoa;
    state.pessoas=state.pessoas.filter(p=>p.id!==id);
    state.cotas=state.cotas.filter(c=>c.pessoaId!==id);
    save(); showToast("Removido.",true);
  }

  if(t.id==="btnAplicarFiltros") aplicarFiltros();

  if(t.id==="btnLimparFiltros"){
    document.getElementById("filtroDe").value="";
    document.getElementById("filtroAte").value="";
    document.getElementById("filtroTipo").value="todos";
    document.getElementById("filtroTomador").value="todos";
    document.getElementById("filtroCorrentista").value="todos";
    aplicarFiltros();
  }

  if(t.id==="btnGerarPayout") gerarTabelaPayout();

  if(t.dataset.payout){
    const [pid,ciclo,valor]=t.dataset.payout.split("::");
    if(state.payouts.some(x=>x.pessoaId===pid&&x.ciclo===ciclo)){
      alert("Já pago."); return;
    }
    state.payouts.push({id:uid(),pessoaId:pid,ciclo,valor:Number(valor),data:today()});
    save(); gerarTabelaPayout(); showToast("Registrado.");
  }

  if(t.dataset.estornar){
    const [pid,ciclo]=t.dataset.estornar.split("::");
    state.payouts=state.payouts.filter(x=>!(x.pessoaId===pid&&x.ciclo===ciclo));
    save(); gerarTabelaPayout(); showToast("Estornado.",true);
  }

  if(t.id==="btnSalvarCfg"){
    state.config.inicio=document.getElementById("cfgInicio").value;
    state.config.fim=document.getElementById("cfgFim").value;
    save(); showToast("Ciclo salvo.");
  }

  if(t.id==="btnExportarBackup"){
    const json=JSON.stringify(state,null,2);
    download("backup_elos.json",json,"application/json");
  }

  if(t.id==="btnImportarBackup"){
    document.getElementById("inputImportBackup").click();
  }

  if(t.id==="btnDefinirPIN"){
    const atual=document.getElementById("pinAtual")?.value||"";
    const novo=document.getElementById("pinNovo")?.value||"";
    if(state.lock.pin && atual!==state.lock.pin) return showToast("PIN atual errado.",true);
    if(novo.length<4||novo.length>10) return showToast("PIN 4–10 dígitos.",true);
    state.lock.pin=novo; state.lock.locked=false; save(); showToast("PIN atualizado.");
  }

  if(t.id==="btnBloquear"){
    if(!state.lock.pin) return showToast("Defina PIN primeiro.",true);
    state.lock.locked=true; save(); showToast("Bloqueado.");
  }

  if(t.id==="btnDesbloquear"){
    const atual=document.getElementById("pinAtual")?.value||"";
    if(atual!==state.lock.pin) return showToast("PIN incorreto.",true);
    state.lock.locked=false; save(); showToast("Desbloqueado.");
  }
});

/* renomear correntistas */
document.addEventListener("input", e=>{
  if(e.target.dataset.pessoaNome){
    const p=state.pessoas.find(x=>x.id===e.target.dataset.pessoaNome);
    if(p) p.nome=e.target.value;
  }
});
document.addEventListener("focusout", e=>{
  if(e.target.dataset.pessoaNome) save();
});

/* auto preencher valor do retorno */
["retornoEmprestimo","retornoTipo"].forEach(id=>{
  document.addEventListener("change", e=>{
    if(e.target.id!==id) return;
    const empId=document.getElementById("retornoEmprestimo").value;
    const tipo=document.getElementById("retornoTipo").value;
    const el=document.getElementById("retornoValor");
    const emp=state.emprestimos.find(x=>x.id===empId);
    if(!emp){ el.value=""; return; }
    const d=devidoEmprestimo(emp);
    const outstanding=Math.max(0,d.total-d.pagos);
    const juros=jurosDoEmprestimo(emp);
    if(tipo==="juros") el.value=Math.min(juros,outstanding).toFixed(2);
    else if(tipo==="misto") el.value=outstanding.toFixed(2);
    else el.value=Math.min(emp.principal,outstanding).toFixed(2);
  });
});


/* ================================================
   MAIN (PARTE 3.4)
================================================ */
function showTab(id){
  document.querySelectorAll(".tab-btn").forEach(b=>{
    b.classList.toggle("active",b.dataset.tab===id);
  });
  document.querySelectorAll("main section.card").forEach(sec=>{
    sec.hidden=(sec.id!==id);
  });
}

function setupTabs(){
  document.querySelector("header nav").addEventListener("click",e=>{
    const btn=e.target.closest(".tab-btn");
    if(btn) showTab(btn.dataset.tab);
  });
}

function importBackup(file){
  const r=new FileReader();
  r.onload=e=>{
    try{
      const json=JSON.parse(e.target.result);
      localStorage.setItem(KEY,JSON.stringify(json));
      location.reload();
    }catch(err){ alert("Backup inválido."); }
  };
  r.readAsText(file);
}

function showToast(msg, warn){
  const t=document.createElement("div");
  t.className="toast";
  if(warn) t.style.borderColor="#ef4444";
  t.textContent=msg;
  document.body.appendChild(t);
  setTimeout(()=>t.remove(),2500);
}

function renderLockStatus(){
  // opcional — você pode adicionar se quiser mostrar status
}

function init(){
  setupTabs();

  document.getElementById("emprestData").value=today();
  document.getElementById("emprestVenc").value=addMonths(today(),1);
  document.getElementById("retornoData").value=today();

  document.getElementById("cfgInicio").value=state.config.inicio;
  document.getElementById("cfgFim").value=state.config.fim;

  document.getElementById("cotistaSelect").addEventListener("change",renderCotas);

  const inp=document.getElementById("inputImportBackup");
  inp.addEventListener("change",e=>{
    const file=e.target.files[0];
    if(file) importBackup(file);
  });

  renderAll();
  aplicarFiltros();
  renderLockStatus();

  showTab("tab-lancamentos");
}

document.addEventListener("DOMContentLoaded",init);
</script>

</body>
</html>
