<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ELOS FORTE INVESTIMENTOS</title>

  <link rel="icon" href="elos_fusao_horizontal_iconOnly_300w.png" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1223;
      --panel:#0f172a;
      --card:#0b1223;
      --soft:#111827;
      --muted:#334155;

      --text:#e5e7eb;
      --sub:#94a3b8;

      --accent:#22c55e;
      --accent-2:#16a34a;

      --danger:#ef4444;
      --warn:#f59e0b;

      --border:#223047;
      --border-2:#273548;

      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --shadow-soft: 0 8px 22px rgba(0,0,0,.22);

      --radius: 18px;

      --font: "Inter", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu;
      --mono: ui-monospace, Menlo, Consolas, monospace;

      --t-fast: 140ms;
      --t-med: 220ms;

      --ring: 0 0 0 3px rgba(34,197,94,.20);
    }

    html[data-theme="light"]{
      --bg:#f5f7fb;
      --panel:#ffffff;
      --card:#ffffff;
      --soft:#f2f5fb;
      --muted:#e5eaf5;

      --text:#0b1223;
      --sub:#475569;

      --border:#e3e8f5;
      --border-2:#d7def0;

      --shadow: 0 12px 28px rgba(15,23,42,.10);
      --shadow-soft: 0 10px 24px rgba(15,23,42,.08);

      --ring: 0 0 0 3px rgba(34,197,94,.18);
    }

    *{box-sizing:border-box}

    body{
      margin:0;
      font-family: var(--font);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(30,41,59,.55) 10%, transparent 60%),
        radial-gradient(1000px 500px at 110% 10%, rgba(11,18,35,.55) 10%, transparent 60%),
        var(--bg);
      color:var(--text);
      min-height:100dvh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    html[data-theme="light"] body{
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(34,197,94,.10) 10%, transparent 60%),
        radial-gradient(1000px 500px at 110% 10%, rgba(59,130,246,.08) 10%, transparent 60%),
        var(--bg);
    }

    .container{max-width:1200px; margin:0 auto; padding:16px}

    h1{
      margin:6px 0 2px;
      font-size:24px;
      letter-spacing:.2px;
      text-align:center;
    }

    .mono{font-family: var(--mono)}
    .muted{color: color-mix(in oklab, var(--sub) 88%, transparent)}
    .val-in{ color: var(--accent); }
    .val-out{ color: var(--danger); }

    header{
      position:sticky;
      top:0;
      z-index:10;
      backdrop-filter: blur(10px);
      background:linear-gradient(180deg,
        color-mix(in oklab, var(--panel) 75%, transparent),
        color-mix(in oklab, var(--panel) 50%, transparent)
      );
      border-bottom:1px solid var(--border);
      box-shadow: var(--shadow-soft);
    }

    header .container{
      display:flex;
      flex-direction:column;
      align-items:center;
      text-align:center;
      gap:6px;
    }

    header nav{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin:10px 0 12px;
      justify-content:center;
    }

    header .logo{
      display:block;
      width:300px;
      height:auto;
      margin:6px auto 2px;
      filter: drop-shadow(0 10px 26px rgba(0,0,0,.22));
    }

    @media (max-width:480px){
      header .logo{ width:220px; }
    }

    header .subtitle{
      display:flex;
      gap:8px;
      justify-content:center;
      align-items:baseline;
      flex-wrap:wrap;
      color:var(--sub);
      font-size:12px;
      letter-spacing:.2px;
    }

    #saldoFundo{
      color: var(--accent);
      font-weight:900;
      font-size: clamp(18px, 2.8vw, 22px);
      line-height:1;
      white-space:nowrap;
    }

    /* Topbar de status (multinacional) */
    .topbar{
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:8px;
      margin-top:6px;
    }
    .badge{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border-2);
      background: color-mix(in oklab, var(--card) 92%, transparent);
      color: color-mix(in oklab, var(--text) 82%, transparent);
      font-weight:800;
      font-size:12px;
      letter-spacing:.2px;
      backdrop-filter: blur(10px);
    }
    .dot{
      width:8px; height:8px; border-radius:999px;
      background: color-mix(in oklab, var(--sub) 70%, transparent);
      box-shadow: 0 0 0 3px color-mix(in oklab, var(--sub) 20%, transparent);
    }
    .badge.ok{ border-color: color-mix(in oklab, var(--accent) 35%, var(--border-2)); }
    .badge.ok .dot{ background: var(--accent); box-shadow: 0 0 0 3px rgba(34,197,94,.18); }
    .badge.warn{ border-color: color-mix(in oklab, var(--warn) 40%, var(--border-2)); }
    .badge.warn .dot{ background: var(--warn); box-shadow: 0 0 0 3px rgba(245,158,11,.18); }
    .badge.bad{ border-color: color-mix(in oklab, var(--danger) 40%, var(--border-2)); }
    .badge.bad .dot{ background: var(--danger); box-shadow: 0 0 0 3px rgba(239,68,68,.18); }

    nav .tab-btn{
      padding:10px 14px;
      border:1px solid var(--border-2);
      border-radius:999px;
      background: color-mix(in oklab, var(--card) 92%, transparent);
      color: color-mix(in oklab, var(--text) 82%, transparent);
      cursor:pointer;
      transition: transform var(--t-fast) ease, box-shadow var(--t-fast) ease, background var(--t-fast) ease, border-color var(--t-fast) ease;
      font-weight:700;
      font-size:13px;
      letter-spacing:.2px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }

    nav .tab-btn:hover{
      transform:translateY(-1px);
      box-shadow:0 10px 26px rgba(34,197,94,.10);
      border-color: color-mix(in oklab, var(--accent) 30%, var(--border-2));
    }

    nav .tab-btn.active{
      background:linear-gradient(90deg, var(--accent-2), var(--accent));
      color: color-mix(in oklab, #071014 90%, transparent);
      border-color:transparent;
      box-shadow:0 12px 28px rgba(34,197,94,.18);
    }

    .grid{display:grid; gap:16px}
    .cols-3{grid-template-columns: repeat(3, minmax(0, 1fr));}
    .cols-2{grid-template-columns: repeat(2, minmax(0, 1fr));}
    @media (max-width:980px){.cols-3{grid-template-columns:1fr}.cols-2{grid-template-columns:1fr}}

    .card{
      background:
        linear-gradient(180deg, color-mix(in oklab, #ffffff 4%, transparent), transparent),
        var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding:16px;
      box-shadow: var(--shadow);
      transition: transform var(--t-med) ease, box-shadow var(--t-med) ease, border-color var(--t-med) ease;
    }

    .card:hover{
      border-color: color-mix(in oklab, var(--accent) 18%, var(--border));
      box-shadow: 0 14px 34px rgba(0,0,0,.22);
    }

    .card h3{margin:0 0 8px; font-size:15px; letter-spacing:.2px}

    label{font-size:12px; color:var(--sub); letter-spacing:.15px}

    input, select{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      background: color-mix(in oklab, var(--panel) 70%, transparent);
      border:1px solid var(--border-2);
      color:var(--text);
      transition: box-shadow var(--t-fast) ease, border-color var(--t-fast) ease, background var(--t-fast) ease;
    }

    input::placeholder{ color: color-mix(in oklab, var(--sub) 75%, transparent); }

    input:focus, select:focus{
      outline:none;
      box-shadow: var(--ring);
      border-color: color-mix(in oklab, var(--accent) 50%, var(--border-2));
    }

    button:focus-visible, input:focus-visible, select:focus-visible{
      outline:none;
      box-shadow: var(--ring);
    }

    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}

    .btn{
      padding:10px 14px;
      border:none;
      border-radius:12px;
      font-weight:800;
      cursor:pointer;
      letter-spacing:.2px;
      transition: transform var(--t-fast) ease, box-shadow var(--t-fast) ease, filter var(--t-fast) ease, background var(--t-fast) ease;
      -webkit-tap-highlight-color: transparent;
    }

    .btn:active{ transform: translateY(1px); }

    .btn-primary{
      background:linear-gradient(90deg, var(--accent-2), var(--accent));
      color:#051014;
      box-shadow: 0 12px 26px rgba(34,197,94,.16);
    }
    .btn-primary:hover{ filter: brightness(1.02); box-shadow: 0 14px 30px rgba(34,197,94,.20); }

    .btn-danger{
      background:linear-gradient(90deg, #ef4444, #f97316);
      color:white;
      box-shadow: 0 12px 26px rgba(239,68,68,.14);
    }

    .btn-ghost{
      background: color-mix(in oklab, var(--card) 92%, transparent);
      border:1px solid var(--border-2);
      color: color-mix(in oklab, var(--text) 82%, transparent);
    }
    .btn-ghost:hover{
      border-color: color-mix(in oklab, var(--accent) 25%, var(--border-2));
      box-shadow: 0 10px 22px rgba(0,0,0,.12);
      transform: translateY(-1px);
    }

    .btn-mini{padding:8px 10px; font-weight:800; border-radius:10px; font-size:12px}

    table{width:100%; border-collapse: collapse; font-size:13px}
    th, td{padding:10px 8px; border-bottom:1px dashed color-mix(in oklab, var(--border) 80%, transparent)}
    th{text-align:left; color:color-mix(in oklab, var(--sub) 95%, transparent); font-weight:800; letter-spacing:.2px}
    tr:hover td{background: color-mix(in oklab, var(--panel) 42%, transparent)}

    .pill{padding:4px 8px; border-radius:999px; font-weight:900; font-size:11px; letter-spacing:.2px}
    .pill.in{background: color-mix(in oklab, var(--accent) 14%, transparent); color: color-mix(in oklab, var(--accent) 92%, #000); border:1px solid color-mix(in oklab, var(--accent) 25%, transparent)}
    .pill.out{background: color-mix(in oklab, var(--danger) 14%, transparent); color: color-mix(in oklab, var(--danger) 92%, #000); border:1px solid color-mix(in oklab, var(--danger) 25%, transparent)}

    .kpi{display:flex; gap:12px; align-items:center}
    .kpi h2{margin:0; font-size:22px; letter-spacing:.2px}
    .kpi small{color:var(--sub)}
    .hint{font-size:12px; color:color-mix(in oklab, var(--sub) 85%, transparent); line-height:1.35}

    footer{
      margin:40px 0 80px;
      color: color-mix(in oklab, var(--sub) 85%, transparent);
      text-align:center;
    }

    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:20px;
      display:flex;
      gap:10px;
      align-items:center;
      background: color-mix(in oklab, var(--card) 92%, transparent);
      border:1px solid var(--border);
      color: color-mix(in oklab, var(--text) 88%, transparent);
      padding:10px 14px;
      border-radius:12px;
      box-shadow: var(--shadow);
      z-index:40;
      backdrop-filter: blur(10px);
    }

    #confirmOverlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:70;
    }
    .cf-modal{
      width:min(460px, 92vw);
      background: color-mix(in oklab, var(--card) 95%, transparent);
      border:1px solid var(--border);
      border-radius:14px;
      box-shadow:var(--shadow);
      padding:16px;
      backdrop-filter: blur(10px);
    }
    .cf-modal h4{ margin:0 0 12px; font-size:16px; letter-spacing:.2px }
    .cf-btns{ display:flex; gap:10px; justify-content:flex-end; margin-top:12px; }
    .cf-no, .cf-yes{ border-radius:10px; padding:10px 14px; font-weight:900; cursor:pointer; letter-spacing:.2px }
    .cf-no{ background:transparent; border:1px solid var(--border-2); color: color-mix(in oklab, var(--text) 85%, transparent); }
    .cf-yes{ background:linear-gradient(90deg, #ef4444, #f97316); color:#fff; border:none; }

    @media (prefers-reduced-motion: reduce){
      *{ transition: none !important; animation: none !important; }
      nav .tab-btn:hover, .btn-ghost:hover, .card:hover{ transform:none !important; }
    }

    .cfg-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:10px;
    }
  </style>
</head>

<body>
<header>
  <div class="container">
    <h1>
      <img class="logo" src="elos_fusao_horizontal_iconOnly_300w.png" alt="ELOS FORTE INVESTIMENTOS">
    </h1>

    <div class="subtitle">
      Ciclo atual: <span id="cycleLabel" class="mono"></span> • Saldo do Fundo: <span id="saldoFundo" class="mono"></span>
    </div>

    <!-- Topbar de status -->
    <div class="topbar" aria-label="Status do sistema">
      <span id="badgeVersion" class="badge ok"><span class="dot" aria-hidden="true"></span>Versão: <b id="buildVersion" class="mono"></b></span>
      <span id="badgeNet" class="badge"><span class="dot" aria-hidden="true"></span>Rede: <b id="netStatus" class="mono"></b></span>
      <span id="badgeStore" class="badge"><span class="dot" aria-hidden="true"></span>Storage: <b id="storageStatus" class="mono"></b></span>
      <span id="badgeImport" class="badge"><span class="dot" aria-hidden="true"></span>Últ. Import: <b id="lastImport" class="mono"></b></span>
      <span id="badgeBackup" class="badge"><span class="dot" aria-hidden="true"></span>Últ. Backup: <b id="lastBackup" class="mono"></b></span>
    </div>

    <nav>
      <button class="tab-btn active" data-tab="tab-lancamentos">Lançamentos (Cotas)</button>
      <button class="tab-btn" data-tab="tab-emprestimos">Empréstimos</button>
      <button class="tab-btn" data-tab="tab-retornos">Retornos (Pagamentos)</button>
      <button class="tab-btn" data-tab="tab-correntistas">Correntistas</button>
      <button class="tab-btn" data-tab="tab-resumo">Resumo & Filtros</button>
      <button class="tab-btn" data-tab="tab-baixa-final">Baixa Final 10%</button>
      <button class="tab-btn" data-tab="tab-config">Config</button>
    </nav>
  </div>
</header>

<main class="container">
  <section class="grid cols-3" id="kpis">
    <div class="card kpi">
      <div><small>Total de Cotas (Ciclo)</small><h2 class="mono" id="kpiTotalCotas">R$ 0,00</h2></div>
    </div>
    <div class="card kpi">
      <div><small>Passivo 10% a Pagar (Ciclo)</small><h2 class="mono" id="kpiPassivo10">R$ 0,00</h2></div>
    </div>
    <div class="card kpi">
      <div><small>Total Juros Recebidos</small><h2 class="mono" id="kpiJuros">R$ 0,00</h2></div>
    </div>
  </section>

  <section id="tab-lancamentos" class="card" style="margin-top:16px">
    <h3>Lançar Cotas Mensais (acréscimo automático de 10% no passivo)</h3>
    <div class="grid cols-3">
      <div><label>Correntista</label><select id="cotistaSelect"></select></div>
      <div><label>Valor (R$)</label><input type="number" id="valorCota" min="0" step="0.01" placeholder="100,00" /></div>
      <div><label>Data</label><input type="date" id="dataCota" /></div>
    </div>
    <div class="row" style="margin-top:12px">
      <button class="btn btn-primary" id="btnAddCota">Adicionar Lançamento</button>
      <span class="hint">Cada lançamento aumenta o saldo do fundo e acumula passivo de 10% para o acerto no fim do ciclo.</span>
    </div>
    <div style="margin-top:8px; overflow:auto">
      <table id="tabelaCotas">
        <thead>
          <tr><th>Data</th><th>Correntista</th><th>Valor</th><th>+10% (Passivo)</th><th>Ciclo</th><th>Ação</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section id="tab-emprestimos" class="card" hidden>
    <h3>Registrar Empréstimo (20% ou 30%)</h3>
    <div class="grid cols-3">
      <div><label>Tomador</label><input type="text" id="emprestTomador" placeholder="Nome do tomador" /></div>
      <div><label>Principal (R$)</label><input type="number" id="emprestPrincipal" min="0" step="0.01" /></div>
      <div>
        <label>Percentual</label>
        <select id="emprestPercentual">
          <option value="0.2">20%</option>
          <option value="0.3">30%</option>
        </select>
      </div>
    </div>

    <div class="grid cols-3" style="margin-top:8px">
      <div>
        <label>Data</label><input type="date" id="emprestData" />
        <label style="margin-top:8px; display:block">Vencimento</label><input type="date" id="emprestVenc" />
      </div>
      <div>
        <label>Status</label>
        <select id="emprestStatus">
          <option value="aberto">Aberto</option>
          <option value="fechado">Fechado</option>
        </select>
      </div>
      <div class="row" style="align-items:flex-end"><button class="btn btn-primary" id="btnAddEmprestimo">Registrar Empréstimo</button></div>
    </div>

    <div class="hint" style="margin-top:8px">Ao registrar um empréstimo, o <b>saldo do fundo diminui</b> pelo principal liberado.</div>

    <div style="margin-top:8px; overflow:auto">
      <table id="tabelaEmprestimos">
        <thead>
          <tr><th>Data</th><th>Tomador</th><th>Principal</th><th>%</th><th>Devido (principal+juros)</th><th>Pago</th><th>Aberto?</th><th>Ação</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div style="margin-top:16px; overflow:auto">
      <h3>Resumo de Cashbacks (5% em empréstimos ≥ R$ 250,00)</h3>
      <table id="tabelaCashbacks">
        <thead><tr><th>Tomador</th><th>Total de Cashbacks</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="hint" style="margin-top:8px">
        Referência rápida: 250→12,50 • 500→25,00 • 750→37,50 • 1000→50,00 • …
      </div>
    </div>

    <div style="margin-top:16px; overflow:auto">
      <h3>Tabela de Referência — Cashback 5% (a partir de R$ 250,00)</h3>
      <table id="tabelaCashbackRef">
        <thead><tr><th>Valor do Empréstimo</th><th>Cashback (5%)</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section id="tab-retornos" class="card" hidden>
    <h3>Registrar Retorno de Empréstimo</h3>
    <div class="grid cols-3">
      <div><label>Empréstimo</label><select id="retornoEmprestimo"></select></div>
      <div><label>Valor Pago (R$)</label><input type="number" id="retornoValor" min="0" step="0.01" /></div>
      <div><label>Data</label><input type="date" id="retornoData" /></div>
    </div>
    <div class="grid cols-3" style="margin-top:8px">
      <div>
        <label>Tipo</label>
        <select id="retornoTipo">
          <option value="misto">Misto (Principal+Juros)</option>
          <option value="principal">Somente Principal</option>
          <option value="juros">Somente Juros</option>
        </select>
      </div>
      <div class="row" style="align-items:flex-end"><button class="btn btn-primary" id="btnAddRetorno">Adicionar Retorno</button></div>
    </div>
    <div class="hint" style="margin-top:8px">
      Cada retorno <b>aumenta</b> o saldo do fundo. Se for juros, também soma no indicador de <b>Juros Recebidos</b>.
      O tipo <b>Misto</b> já preenche o valor devido para quitar o empréstimo.
    </div>
    <div style="margin-top:8px; overflow:auto">
      <table id="tabelaRetornos">
        <thead><tr><th>Data</th><th>Tomador</th><th>Valor</th><th>Tipo</th><th>Empréstimo</th><th>Ação</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section id="tab-correntistas" class="card" hidden>
    <h3>Gerenciar Correntistas</h3>
    <div class="row" style="margin-bottom:8px">
      <button class="btn btn-ghost" id="btnAddPessoa">Adicionar Pessoa</button>
      <button class="btn btn-danger" id="btnResetDados">Zerar Tudo (cautela)</button>
    </div>
    <div style="overflow:auto; margin-top:8px">
      <table id="tabelaPessoas">
        <thead><tr><th style="width:56px">#</th><th style="width:36%">Nome</th><th>Total Cotas</th><th>Previsão 10%</th><th>Parcela</th><th style="width:120px">Ação</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section id="tab-resumo" class="card" hidden>
    <h3>Resumo & Filtros</h3>
    <div class="grid cols-3">
      <div><label>De</label><input type="date" id="filtroDe"></div>
      <div><label>Até</label><input type="date" id="filtroAte"></div>
      <div>
        <label>Tipo</label>
        <select id="filtroTipo">
          <option value="todos">Todos</option>
          <option value="cotas">Cotas</option>
          <option value="emprestimos">Empréstimos</option>
          <option value="emp_vencidos">Empréstimos Vencidos</option>
          <option value="emp_avencer">Empréstimos a Vencer (7 dias)</option>
          <option value="retornos">Retornos</option>
          <option value="payouts">Baixas Finais</option>
        </select>
      </div>
    </div>
    <div class="grid cols-3" style="margin-top:8px">
      <div><label>Tomador (Empréstimos/Retornos)</label><select id="filtroTomador"></select></div>
      <div><label>Correntista (Cotas)</label><select id="filtroCorrentista"></select></div>
    </div>
    <div class="row" style="margin:12px 0">
      <button class="btn btn-primary" id="btnAplicarFiltros">Aplicar Filtros</button>
      <button class="btn btn-ghost" id="btnLimparFiltros">Limpar</button>
      <button class="btn btn-ghost btn-mini" id="btnExportResumoCSV">Exportar (CSV)</button>
      <button class="btn btn-ghost btn-mini" id="btnExportResumoXLS">Exportar (Excel)</button>
    </div>

    <div class="grid cols-2">
      <div class="card">
        <h3>Movimentos (Filtrados)</h3>
        <div style="overflow:auto; margin-top:8px">
          <table id="tabelaMovimentos">
            <thead><tr><th>Data</th><th>Tipo</th><th>Descrição</th><th>Valor</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="card">
        <h3>Totais (Período)</h3>
        <ul id="totaisPeriodo" class="muted"></ul>
      </div>
    </div>
  </section>

  <section id="tab-baixa-final" class="card" hidden>
    <h3>Baixa Final do Ciclo (devolver cotas + 10%)</h3>
    <div class="grid cols-3">
      <div><label>Ciclo</label><select id="cicloPayout"></select></div>
      <div class="row" style="align-items:flex-end; gap:8px">
        <button class="btn btn-primary" id="btnGerarPayout">Calcular Pagamento Final</button>
        <button class="btn btn-ghost btn-mini" id="btnExportPayoutCSV">Exportar CSV</button>
        <button class="btn btn-ghost btn-mini" id="btnExportPayoutXLS">Exportar Excel</button>
      </div>
    </div>
    <div style="margin-top:8px; overflow:auto">
      <table id="tabelaPayouts">
        <thead><tr><th>Correntista</th><th>Total Cotas</th><th>10%</th><th>Devolver</th><th>Ação</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section id="tab-config" class="card" hidden>
    <h3>Configurações & Utilitários</h3>

    <div class="grid cols-3">
      <div><label>Início do Ciclo</label><input type="month" id="cfgInicio"></div>
      <div><label>Fim do Ciclo</label><input type="month" id="cfgFim"></div>
      <div class="row" style="align-items:flex-end">
        <button class="btn btn-primary" id="btnSalvarCfg">Salvar Ciclo</button>
      </div>
    </div>

    <div class="cfg-actions">
      <span class="badge ok"><span class="dot" aria-hidden="true"></span>UI Premium</span>
      <span class="badge"><span class="dot" aria-hidden="true"></span>Tema: <span id="themeLabel" class="mono" style="margin-left:6px;"></span></span>
      <button class="btn btn-ghost btn-mini" id="btnToggleTheme">Alternar Tema</button>
    </div>

    <hr style="border-color: var(--border); opacity:.45; margin:16px 0">

    <div>
      <h3 style="margin:0 0 8px">Backup (Exportar/Importar JSON)</h3>
      <div class="row">
        <button class="btn btn-ghost btn-mini" id="btnExportarBackup">Exportar Backup (.json)</button>
        <button class="btn btn-primary btn-mini" id="btnExportarBackupAuto">Backup Automático (timestamp)</button>
        <input type="file" id="inputImportBackup" accept=".json,application/json" hidden>
        <button class="btn btn-ghost btn-mini" id="btnImportarBackup">Importar Backup (.json)</button>
        <span class="hint">Importar exige estar desbloqueado.</span>
      </div>
      <div class="hint" style="margin-top:8px">O backup automático salva com data e hora no nome do arquivo e registra “Últ. Backup” na topbar.</div>
    </div>

    <hr style="border-color: var(--border); opacity:.45; margin:16px 0">

    <div>
      <h3 style="margin:0 0 8px">Bloqueio por PIN</h3>
      <div class="grid cols-3">
        <div><label>PIN atual</label><input type="password" id="pinAtual" placeholder="se existir"></div>
        <div><label>Novo PIN</label><input type="password" id="pinNovo" placeholder="4-10 dígitos"></div>
        <div class="row" style="align-items:flex-end; gap:8px">
          <button class="btn btn-ghost btn-mini" id="btnDefinirPIN">Definir/Alterar PIN</button>
          <button class="btn btn-ghost btn-mini" id="btnBloquear">Bloquear</button>
          <button class="btn btn-ghost btn-mini" id="btnDesbloquear">Desbloquear</button>
        </div>
      </div>
      <div class="hint" style="margin-top:6px">Status: <b id="lockStatus">—</b></div>
    </div>
  </section>

  <footer>
    <div>Plataforma © 2025 — Gestão simples e clara. <b>ELOS FORTE</b> • <span class="mono" id="footerVersion"></span></div>
  </footer>
</main>

<div id="confirmOverlay" aria-hidden="true">
  <div class="cf-modal">
    <h4 id="confirmTitle">Confirmar ação</h4>
    <div id="confirmText" class="muted">Tem certeza?</div>
    <div class="cf-btns">
      <button class="cf-no" id="confirmNo">Não</button>
      <button class="cf-yes" id="confirmYes">Sim</button>
    </div>
  </div>
</div>

<script>
/* ===== Build ===== */
const APP_VERSION = 'v2.5.1';
const LAST_IMPORT_KEY = 'elos_last_import_v1';
const LAST_BACKUP_KEY = 'elos_last_backup_v1';

/* ===== Utils ===== */
const BRL = new Intl.NumberFormat('pt-BR', {style:'currency', currency:'BRL'});
const fmt = n => BRL.format(Number(n||0));
const uid = () => Date.now().toString(36) + Math.random().toString(36).slice(2,7);
const today= () => new Date().toISOString().slice(0,10);
const monthStr = d => (d||'').slice(0,7);
const addMonths = (dateStr, m=1) => {
  const d=new Date(dateStr||today());
  d.setMonth(d.getMonth()+m);
  return d.toISOString().slice(0,10);
};
function download(filename, content, mime='application/octet-stream'){
  const blob = new Blob([content], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url;
  a.download=filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
function pad2(n){ return String(n).padStart(2,'0'); }
function fileSafeTimestamp(d=new Date()){
  return d.getFullYear() + '-' + pad2(d.getMonth()+1) + '-' + pad2(d.getDate()) + '_' + pad2(d.getHours()) + '-' + pad2(d.getMinutes()) + '-' + pad2(d.getSeconds());
}

/* ===== Modal de Confirmação ===== */
function confirmDialog(message, title='Confirmar ação'){
  return new Promise(resolve=>{
    const ov=document.getElementById('confirmOverlay');
    const txt=document.getElementById('confirmText');
    const ttl=document.getElementById('confirmTitle');
    const yes=document.getElementById('confirmYes');
    const no =document.getElementById('confirmNo');
    function close(v){
      yes.onclick = no.onclick = null;
      ov.style.display='none';
      ov.setAttribute('aria-hidden','true');
      resolve(v);
    }
    ttl.textContent = title;
    txt.textContent = message;
    ov.style.display='flex';
    ov.setAttribute('aria-hidden','false');
    yes.focus();
    yes.onclick = ()=>close(true);
    no.onclick = ()=>close(false);
    ov.addEventListener('keydown', (e)=>{
      if(e.key==='Escape'){ e.preventDefault(); close(false); }
      if(e.key==='Enter'){ e.preventDefault(); close(true); }
    }, {once:true});
  });
}

/* ===== Tema ===== */
const THEME_KEY = 'elos_theme_v1';
function getTheme(){ return localStorage.getItem(THEME_KEY) || 'dark'; }
function setTheme(theme){
  const t = (theme === 'light') ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', t);
  localStorage.setItem(THEME_KEY, t);
  const lbl = document.getElementById('themeLabel');
  if(lbl) lbl.textContent = (t === 'light') ? 'Light' : 'Dark';
}
function toggleTheme(){ setTheme(getTheme() === 'dark' ? 'light' : 'dark'); }

/* ===== Status (Rede/Storage/Import/Backup) ===== */
function setBadgeState(badgeId, state){ // ok|warn|bad|neutral
  const el = document.getElementById(badgeId);
  if(!el) return;
  el.classList.remove('ok','warn','bad');
  if(state==='ok') el.classList.add('ok');
  else if(state==='warn') el.classList.add('warn');
  else if(state==='bad') el.classList.add('bad');
}
function fmtDateTimeLocal(iso){
  try{
    if(!iso) return '—';
    const d = new Date(iso);
    if(isNaN(d.getTime())) return '—';
    return d.toLocaleString('pt-BR');
  }catch(_){ return '—'; }
}
function updateNetStatus(){
  const online = navigator.onLine;
  const t = online ? 'ONLINE' : 'OFFLINE';
  const el = document.getElementById('netStatus');
  if(el) el.textContent = t;
  setBadgeState('badgeNet', online ? 'ok' : 'warn');
}
function updateStorageStatus(){
  let ok = true;
  try{
    const k='__t__'+Date.now();
    localStorage.setItem(k,'1');
    localStorage.removeItem(k);
  }catch(_){ ok=false; }
  const el = document.getElementById('storageStatus');
  if(el) el.textContent = ok ? 'OK' : 'FALHA';
  setBadgeState('badgeStore', ok ? 'ok' : 'bad');
}
function updateImportStatus(){
  const iso = localStorage.getItem(LAST_IMPORT_KEY) || '';
  const el = document.getElementById('lastImport');
  if(el) el.textContent = fmtDateTimeLocal(iso);
  setBadgeState('badgeImport', iso ? 'ok' : 'warn');
}
function updateBackupStatus(){
  const iso = localStorage.getItem(LAST_BACKUP_KEY) || '';
  const el = document.getElementById('lastBackup');
  if(el) el.textContent = fmtDateTimeLocal(iso);
  setBadgeState('badgeBackup', iso ? 'ok' : 'warn');
}

/* ===== Estado ===== */
const KEY = 'plataforma_cotas_v1';
const state = JSON.parse(localStorage.getItem(KEY) || 'null') || {
  config: { inicio: '2024-12', fim: '2025-11' },
  pessoas: [],
  cotas: [],
  emprestimos: [],
  retornos: [],
  payouts: [],
  cashbacks: [],
  seqEmprestimo: 1,
  lock: { pin:'', locked:false }
};
if (!state.cashbacks) state.cashbacks = [];
if (!state.lock) state.lock = {pin:'', locked:false};
if (typeof state.seqEmprestimo!=='number') state.seqEmprestimo = 1;

function save(){
  localStorage.setItem(KEY, JSON.stringify(state));
  renderAll();
}
function ensureNotLocked(){
  if(state.lock && state.lock.locked){
    alert('Edição bloqueada por PIN. Desbloqueie em Config.');
    return false;
  }
  return true;
}

/* Bootstrap 15 pessoas */
if(state.pessoas.length===0){
  for(let i=1;i<=15;i++) state.pessoas.push({id:uid(), nome:'Pessoa '+i});
  save();
}

/* ===== Tabs ===== */
function showTab(id){
  document.querySelectorAll('.tab-btn').forEach(b=>{
    b.classList.toggle('active', b.dataset.tab === id);
  });
  document.querySelectorAll('main section.card').forEach(s=>{
    s.hidden = (s.id !== id);
  });
}
function setupTabs(){
  const nav=document.querySelector('header nav');
  nav.addEventListener('click',(e)=>{
    const btn=e.target.closest('.tab-btn');
    if(!btn) return;
    showTab(btn.dataset.tab);
  });
}

/* ===== Cálculos ===== */
function cicloAtualLabel(){ return state.config.inicio + ' → ' + state.config.fim; }
function cicloDeData(dateStr){
  const m = monthStr(dateStr);
  const ini = state.config.inicio;
  const fim = state.config.fim;
  if (m >= ini && m <= fim) return ini + '→' + fim;
  return m;
}
function jurosDoCiclo(e){ return Number(e.principal) * Number(e.percentual); }
function devidoEmprestimo(e){
  const juros = jurosDoCiclo(e);
  const total = Number(e.principal) + juros + Number(e.extra || 0);
  const pagos = state.retornos.filter(r=>r.emprestimoId===e.id)
    .reduce((s,r)=>s+Number(r.valor),0);
  return { total, pagos, aberto: (pagos + 0.01) < total };
}
function totalCotas(cicloLabel){
  return state.cotas.filter(c=>!cicloLabel || c.ciclo===cicloLabel)
    .reduce((s,c)=>s+Number(c.valor),0);
}
function passivo10(cicloLabel){
  const base = totalCotas(cicloLabel)*0.10;
  const pagos10 = state.payouts
    .filter(p=>!cicloLabel || p.ciclo===cicloLabel)
    .reduce((s,p)=> s + Number(p.valor)/11, 0);
  return Math.max(0, base - pagos10);
}
function jurosRecebidos(){
  return state.retornos
    .filter(r=>r.tipo!=='principal')
    .reduce((s,r)=>s+Number(r.valor),0);
}
function totalRetornos(){ return state.retornos.reduce((s,r)=>s+Number(r.valor),0); }
function totalPayouts(){ return state.payouts.reduce((s,p)=>s+Number(p.valor),0); }
function totalEmprestimosLiberados(){ return state.emprestimos.reduce((s,e)=>s+Number(e.principal),0); }
function saldoFundo(){ return totalCotas() + totalRetornos() - totalEmprestimosLiberados() - totalPayouts(); }

/* ===== Render Helpers ===== */
function setText(id, text){ const el=document.getElementById(id); if(el) el.textContent = text; }
function clear(el){ while(el.firstChild) el.removeChild(el.firstChild); }
function empShortId(e){ const m=(e.codigo||'').match(/(\d+)/); return m? m[1] : (e.codigo||'—'); }

/* ===== Header & KPIs ===== */
function renderHeader(){
  setText('cycleLabel', cicloAtualLabel());
  setText('saldoFundo', fmt(saldoFundo()));
  setText('buildVersion', APP_VERSION);
  setText('footerVersion', APP_VERSION);
}

/* ===== KPIs ===== */
function renderKPIs(){
  const label = state.config.inicio + '→' + state.config.fim;
  setText('kpiTotalCotas', fmt(totalCotas(label)));
  setText('kpiPassivo10', fmt(passivo10(label)));
  setText('kpiJuros', fmt(jurosRecebidos()));
}

/* ===== Cotas ===== */
function renderCotas(){
  const sel = document.getElementById('cotistaSelect');
  const prev = sel.value || null;
  clear(sel);
  state.pessoas.forEach(p=>{
    const o=document.createElement('option');
    o.value=p.id;
    o.textContent=p.nome;
    sel.appendChild(o);
  });
  if (prev && Array.prototype.some.call(sel.options, o=>o.value===prev)) { sel.value = prev; }
  const dataEl = document.getElementById('dataCota');
  if (!dataEl.value) dataEl.value = today();
  const filtroId = sel.value || null;

  const tb=document.querySelector('#tabelaCotas tbody');
  clear(tb);
  state.cotas
    .filter(c=> !filtroId || c.pessoaId === filtroId)
    .slice()
    .sort((a,b)=>a.data.localeCompare(b.data))
    .forEach(c=>{
      const p=state.pessoas.find(x=>x.id===c.pessoaId);
      const tr=document.createElement('tr');
      tr.innerHTML=
        '<td>'+c.data+'</td>'+
        '<td>'+(p? p.nome:'—')+'</td>'+
        '<td class="val-in">'+fmt(c.valor)+'</td>'+
        '<td class="muted">'+fmt(c.valor*0.10)+'</td>'+
        '<td class="muted">'+c.ciclo+'</td>'+
        '<td><button class="btn btn-ghost" data-del-cota="'+c.id+'">Excluir</button></td>';
      tb.appendChild(tr);
    });
}

/* ===== Empréstimos ===== */
function renderEmprestimos(){
  const tb=document.querySelector('#tabelaEmprestimos tbody');
  clear(tb);

  state.emprestimos.slice().sort((a,b)=>a.data.localeCompare(b.data)).forEach(e=>{
    const d=devidoEmprestimo(e);
    const tr=document.createElement('tr');
    tr.innerHTML=
      '<td>'+e.data+'</td>'+
      '<td>'+e.tomador+'<div class="muted mono">'+(e.codigo||'')+' • Venc.: '+(e.vencimento||'—')+'</div></td>'+
      '<td class="val-out">'+fmt(e.principal)+'</td>'+
      '<td>'+Math.round(Number(e.percentual)*100)+'%</td>'+
      '<td>'+fmt(d.total)+'</td>'+
      '<td class="'+((d.pagos + 0.009 >= d.total)?'val-in':'')+'">'+fmt(d.pagos)+'</td>'+
      '<td>'+(d.aberto? '<span class="pill out">Aberto</span>':'<span class="pill in">Fechado</span>')+'</td>'+
      '<td><button class="btn btn-ghost" data-close-emp="'+e.id+'">'+(d.aberto? 'Fechar':'Reabrir')+'</button> '+
      '<button class="btn btn-ghost" data-del-emp="'+e.id+'">Excluir</button></td>';
    tb.appendChild(tr);
  });

  const sel=document.getElementById('retornoEmprestimo');
  clear(sel);
  state.emprestimos.forEach(e=>{
    const d=devidoEmprestimo(e);
    if(!d.aberto) return;
    const opt=document.createElement('option');
    opt.value=e.id;
    opt.textContent='ID '+empShortId(e)+' • '+e.tomador+' • '+fmt(e.principal)+' • '+Math.round(Number(e.percentual)*100)+'% • Devido '+fmt(d.total-d.pagos);
    sel.appendChild(opt);
  });
  if(!sel.options.length){
    const o=document.createElement('option');
    o.textContent='— nenhum empréstimo aberto —';
    sel.appendChild(o);
  }
}

/* ===== Cashbacks ===== */
function renderCashbacks(){
  const tb=document.querySelector('#tabelaCashbacks tbody');
  clear(tb);
  if (!state.cashbacks || !state.cashbacks.length){
    const tr=document.createElement('tr');
    tr.innerHTML='<td class="muted" colspan="2">Nenhum cashback gerado.</td>';
    tb.appendChild(tr);
    return;
  }
  const mapa = {};
  state.cashbacks.forEach(cb=>{
    mapa[cb.tomador] = (mapa[cb.tomador]||0) + Number(cb.valor);
  });
  Object.keys(mapa).sort((a,b)=>a.localeCompare(b)).forEach(nome=>{
    const tr=document.createElement('tr');
    tr.innerHTML='<td>'+nome+'</td><td class="val-in">'+fmt(mapa[nome])+'</td>';
    tb.appendChild(tr);
  });
}

/* ===== Referência Cashback (só dados) ===== */
function renderCashbackRef(){
  const tb = document.querySelector('#tabelaCashbackRef tbody');
  if(!tb) return;
  clear(tb);
  const start = 250, step = 250, rows = 16;
  for(let i=0;i<rows;i++){
    const principal = start + (i*step);
    const cb = Number((principal * 0.05).toFixed(2));
    const tr = document.createElement('tr');
    tr.innerHTML = '<td class="mono">'+fmt(principal)+'</td><td class="val-in mono">'+fmt(cb)+'</td>';
    tb.appendChild(tr);
  }
}

/* ===== Retornos ===== */
function renderRetornos(){
  const tb=document.querySelector('#tabelaRetornos tbody');
  clear(tb);
  state.retornos.slice().sort((a,b)=>a.data.localeCompare(b.data)).forEach(r=>{
    const e=state.emprestimos.find(x=>x.id===r.emprestimoId);
    const tr=document.createElement('tr');
    tr.innerHTML=
      '<td>'+r.data+'</td>'+
      '<td>'+(e? e.tomador:'—')+'</td>'+
      '<td class="val-in">'+fmt(r.valor)+'</td>'+
      '<td>'+r.tipo+'</td>'+
      '<td class="muted">'+(e? 'ID '+empShortId(e):'—')+'</td>'+
      '<td><button class="btn btn-ghost" data-del-ret="'+r.id+'">Excluir</button></td>';
    tb.appendChild(tr);
  });
}

/* ===== Pessoas ===== */
function renderPessoas(){
  const tb=document.querySelector('#tabelaPessoas tbody');
  clear(tb);
  const cicloLabel = state.config.inicio + '→' + state.config.fim;
  state.pessoas.forEach((p,i)=>{
    const tot=state.cotas.filter(c=>c.pessoaId===p.id && c.ciclo===cicloLabel).reduce((s,c)=>s+Number(c.valor),0);
    const qtd=state.cotas.filter(c=>c.pessoaId===p.id && c.ciclo===cicloLabel).length;
    const tr=document.createElement('tr');
    tr.innerHTML=
      '<td>'+(i+1)+'</td>'+
      '<td><input data-pessoa-nome="'+p.id+'" value="'+p.nome+'"/></td>'+
      '<td class="val-in">'+fmt(tot)+'</td>'+
      '<td class="muted">'+fmt(tot*0.10)+'</td>'+
      '<td class="muted">'+Math.min(qtd,12)+'/12</td>'+
      '<td><button class="btn btn-ghost" data-del-pessoa="'+p.id+'">Remover</button></td>';
    tb.appendChild(tr);
  });
}

/* ===== Resumo & Filtros ===== */
let lastResumoRows = [];
function populateFilterCombos(){
  const tSel=document.getElementById('filtroTomador');
  const cSel=document.getElementById('filtroCorrentista');
  const setTom=new Set(state.emprestimos.map(e=>e.tomador).filter(Boolean));
  const setCor=new Set(state.pessoas.map(p=>p.nome).filter(Boolean));
  function refill(sel, items){
    const cur = sel.value || 'todos';
    sel.innerHTML='';
    const optAll=document.createElement('option');
    optAll.value='todos';
    optAll.textContent='Todos';
    sel.appendChild(optAll);
    Array.from(items).sort((a,b)=>a.localeCompare(b)).forEach(v=>{
      const o=document.createElement('option');
      o.value=v;
      o.textContent=v;
      sel.appendChild(o);
    });
    sel.value = (Array.from(items).indexOf(cur)>=0)? cur : 'todos';
  }
  refill(tSel,setTom);
  refill(cSel,setCor);
}

function aplicarFiltros(){
  const de=document.getElementById('filtroDe').value || '0000-01-01';
  const ate=document.getElementById('filtroAte').value || '9999-12-31';
  const tipo=document.getElementById('filtroTipo').value;
  const tomSel=document.getElementById('filtroTomador').value || 'todos';
  const corSel=document.getElementById('filtroCorrentista').value || 'todos';
  const linhas=[];
  let totIn=0, totOut=0;
  const hoje=today();

  if(tipo==='todos' || tipo==='cotas'){
    state.cotas.filter(c=>c.data>=de && c.data<=ate).forEach(c=>{
      const p=state.pessoas.find(x=>x.id===c.pessoaId);
      const nome=p? p.nome:'—';
      if(corSel!=='todos' && nome!==corSel) return;
      linhas.push({data:c.data, tipo:'Cota', desc:nome, valor:Number(c.valor)});
      totIn += Number(c.valor);
    });
  }

  if(['todos','emprestimos','emp_vencidos','emp_avencer'].includes(tipo)){
    state.emprestimos.forEach(e=>{
      if(tomSel!=='todos' && e.tomador!==tomSel) return;
      const vence = e.vencimento || e.data;
      const d=devidoEmprestimo(e);
      const aberto=d.aberto;
      const vencido = aberto && vence < hoje;
      const avencer = aberto && !vencido && (new Date(vence) - new Date(hoje) <= 7*24*3600*1000);
      const dentroJanela =
        (tipo==='emprestimos' && e.data>=de && e.data<=ate) ||
        (tipo==='emp_vencidos' && vencido && vence>=de && vence<=ate) ||
        (tipo==='emp_avencer' && avencer && vence>=de && vence<=ate) ||
        (tipo==='todos' && e.data>=de && e.data<=ate);
      if(!dentroJanela) return;
      const rot = tipo==='emp_vencidos' ? 'Empréstimo (Vencido)' : tipo==='emp_avencer' ? 'Empréstimo (A vencer)' : 'Empréstimo';
      linhas.push({
        data:(tipo==='emp_vencidos' || tipo==='emp_avencer') ? vence : e.data,
        tipo:rot,
        desc:'[ID '+empShortId(e)+'] '+e.tomador+' • Venc.: '+(e.vencimento||'—'),
        valor:-Number(e.principal)
      });
      totOut += Number(e.principal);
    });
  }

  if(tipo==='todos' || tipo==='retornos'){
    state.retornos.filter(r=>r.data>=de && r.data<=ate).forEach(r=>{
      const e=state.emprestimos.find(x=>x.id===r.emprestimoId);
      const desc=e? '[ID '+empShortId(e)+'] '+e.tomador : '—';
      if(tomSel!=='todos' && e && e.tomador!==tomSel) return;
      linhas.push({data:r.data, tipo:'Retorno '+r.tipo, desc:desc, valor:Number(r.valor)});
      totIn+=Number(r.valor);
    });
  }

  if(tipo==='todos' || tipo==='payouts'){
    state.payouts.filter(p=>p.data>=de && p.data<=ate).forEach(p=>{
      const pes=state.pessoas.find(x=>x.id===p.pessoaId);
      linhas.push({data:p.data, tipo:'Baixa Final', desc:pes? pes.nome:'—', valor:-Number(p.valor)});
      totOut+=Number(p.valor);
    });
  }

  linhas.sort((a,b)=>a.data.localeCompare(b.data));
  lastResumoRows = linhas.slice();

  const tb=document.querySelector('#tabelaMovimentos tbody');
  clear(tb);
  for(const l of linhas){
    const cls=(l.valor>=0)?'val-in':'val-out';
    const tr=document.createElement('tr');
    tr.innerHTML='<td>'+l.data+'</td><td>'+l.tipo+'</td><td>'+l.desc+'</td><td class="'+cls+'">'+fmt(l.valor)+'</td>';
    tb.appendChild(tr);
  }

  const ul=document.getElementById('totaisPeriodo');
  ul.innerHTML='';
  ul.innerHTML+='<li>Entradas: <b>'+fmt(totIn)+'</b></li>';
  ul.innerHTML+='<li>Saídas: <b>'+fmt(totOut)+'</b></li>';
  ul.innerHTML+='<li>Saldo Líquido: <b>'+fmt(totIn - totOut)+'</b></li>';
}

/* ===== Backup ===== */
function exportBackup(){
  const json = JSON.stringify(state, null, 2);
  download('backup_plataforma.json', json, 'application/json;charset=utf-8;');
}

/* ✅ Backup Automático (timestamp) */
function exportBackupAuto(){
  const now = new Date();
  const json = JSON.stringify(state, null, 2);
  const name = 'backup_' + fileSafeTimestamp(now) + '.json';
  download(name, json, 'application/json;charset=utf-8;');
  localStorage.setItem(LAST_BACKUP_KEY, now.toISOString());
  updateBackupStatus();
  showToast('Backup automático gerado: ' + name);
}

function importBackup(file){
  if(state.lock && state.lock.locked){
    const pin = prompt('Painel bloqueado. Digite o PIN para importar o backup:');
    if(pin === null) return;
    if(pin !== (state.lock.pin || '')){
      showToast('PIN incorreto. Importação cancelada.', true);
      return;
    }
    state.lock.locked = false;
    localStorage.setItem(KEY, JSON.stringify(state));
  }

  const reader = new FileReader();
  reader.onload = e=>{
    try{
      const data = JSON.parse(e.target.result);
      if(!data || !data.config) throw new Error('Formato inválido: faltou "config".');
      if(!Array.isArray(data.pessoas)) throw new Error('Formato inválido: "pessoas" precisa ser lista.');
      if(!Array.isArray(data.cotas)) throw new Error('Formato inválido: "cotas" precisa ser lista.');
      if(!Array.isArray(data.emprestimos)) data.emprestimos = [];
      if(!Array.isArray(data.retornos)) data.retornos = [];
      if(!Array.isArray(data.payouts)) data.payouts = [];
      if(!Array.isArray(data.cashbacks)) data.cashbacks = [];
      if(!data.lock) data.lock = { pin: (state.lock && state.lock.pin) || '', locked: false };
      if(typeof data.seqEmprestimo !== 'number') data.seqEmprestimo = 1;

      localStorage.setItem(KEY, JSON.stringify(data));
      localStorage.setItem(LAST_IMPORT_KEY, new Date().toISOString());
      updateImportStatus();

      showToast('Backup importado com sucesso. Recarregando...');
      setTimeout(()=>location.reload(), 450);
    }catch(err){
      alert('Falha ao importar: ' + err.message);
    }
  };
  reader.onerror = ()=> alert('Falha ao ler o arquivo.');
  reader.readAsText(file);
}

/* ===== Toast ===== */
let toastTimer=null;
function showToast(msg, warn){
  if(document.querySelector('.toast')) document.querySelector('.toast').remove();
  const t=document.createElement('div');
  t.className='toast';
  t.innerHTML='<span>'+msg+'</span>';
  if(warn){ t.style.borderColor='#7f1d1d'; }
  document.body.appendChild(t);
  clearTimeout(toastTimer);
  toastTimer=setTimeout(function(){ t.remove(); }, 2600);
}

/* ===== PIN ===== */
function renderLockStatus(){
  const hasPin = (state.lock && state.lock.pin && state.lock.pin.length>0);
  const lbl = (state.lock && state.lock.locked) ? 'Bloqueado' : 'Desbloqueado';
  document.getElementById('lockStatus').textContent = lbl + (hasPin ? ' • PIN definido' : ' • sem PIN');
}

/* ===== Baixa Final ===== */
function renderCiclosPayout(){
  const sel=document.getElementById('cicloPayout');
  clear(sel);
  const set=new Set(state.cotas.map(c=>c.ciclo));
  const arr=Array.from(set.values());
  if(arr.length===0){
    const opt=document.createElement('option');
    opt.textContent='—';
    sel.appendChild(opt);
    return;
  }
  arr.forEach(function(c){
    const opt=document.createElement('option');
    opt.value=c;
    opt.textContent=c;
    sel.appendChild(opt);
  });
}
function getPayoutRows(ciclo){
  const porPessoa=new Map();
  state.cotas.filter(c=>c.ciclo===ciclo).forEach(function(c){
    porPessoa.set(c.pessoaId,(porPessoa.get(c.pessoaId)||0) + Number(c.valor));
  });
  const rows = [];
  state.pessoas.forEach(function(p){
    const tot=porPessoa.get(p.id)||0;
    if(tot<=0) return;
    const dez=tot*0.10;
    const devolver=tot+dez;
    rows.push({pessoaId:p.id, nome:p.nome, total:tot, dez:dez, devolver:devolver});
  });
  return rows;
}
function gerarTabelaPayout(){
  const ciclo=document.getElementById('cicloPayout').value;
  const tb=document.querySelector('#tabelaPayouts tbody');
  clear(tb);
  const rows = getPayoutRows(ciclo);
  rows.forEach(function(r){
    const ja = state.payouts.some(function(p){ return p.pessoaId===r.pessoaId && p.ciclo===ciclo; });
    const tr=document.createElement('tr');
    tr.innerHTML=
      '<td>'+r.nome+' '+(ja? '<span class="pill in" style="margin-left:6px;">PAGO</span>':'')+'</td>'+
      '<td class="val-in">'+fmt(r.total)+'</td>'+
      '<td class="muted">'+fmt(r.dez)+'</td>'+
      '<td class="val-out"><b>'+fmt(r.devolver)+'</b></td>'+
      '<td>'+
        (ja
          ? '<button class="btn btn-ghost" data-estornar="'+r.pessoaId+'::'+ciclo+'">Estornar</button>'
          : '<button class="btn btn-primary" data-payout="'+r.pessoaId+'::'+ciclo+'::'+r.devolver+'">Registrar Baixa</button>'
        )+
      '</td>';
    tb.appendChild(tr);
  });
}
function exportPayout(ciclo, mode){
  if(!ciclo || ciclo==='—'){ alert('Selecione um ciclo.'); return; }
  const rows = getPayoutRows(ciclo);
  if(rows.length===0){ alert('Não há dados para exportar neste ciclo.'); return; }
  if(mode==='csv'){
    const header = ['Correntista','Total Cotas','10%','Devolver'];
    const csv = [header.join(';')].concat(
      rows.map(function(r){
        return [r.nome, r.total.toFixed(2).replace('.',','), r.dez.toFixed(2).replace('.',','), r.devolver.toFixed(2).replace('.',',')].join(';');
      })
    ).join('\n');
    download('baixa_final_'+ciclo+'.csv', csv, 'text/csv;charset=utf-8;');
  }else{
    const body = rows.map(function(r){
      return '<tr><td>'+r.nome+'</td><td>'+r.total.toFixed(2)+'</td><td>'+r.dez.toFixed(2)+'</td><td>'+r.devolver.toFixed(2)+'</td></tr>';
    }).join('');
    const table = '<table border="1"><tr><th>Correntista</th><th>Total Cotas</th><th>10%</th><th>Devolver</th></tr>'+body+'</table>';
    download('baixa_final_'+ciclo+'.xls', table, 'application/vnd.ms-excel');
  }
}

/* ===== Render All ===== */
function renderAll(){
  renderHeader();
  renderKPIs();
  renderCotas();
  renderEmprestimos();
  renderCashbacks();
  renderCashbackRef();
  renderRetornos();
  renderPessoas();
  renderCiclosPayout();
  populateFilterCombos();

  updateNetStatus();
  updateStorageStatus();
  updateImportStatus();
  updateBackupStatus();
}

/* ===== Eventos ===== */
addEventListener('click', async e=>{
  const t=e.target;

  if(t.id==='btnToggleTheme'){
    toggleTheme();
    showToast('Tema atualizado.');
    return;
  }

  /* BACKUP */
  if(t.id==='btnExportarBackupAuto'){
    exportBackupAuto();
    return;
  }

  /* COTAS */
  if(t.id==='btnAddCota'){
    if(!ensureNotLocked()) return;
    const pessoaId=document.getElementById('cotistaSelect').value;
    const valor=Number(document.getElementById('valorCota').value||0);
    const data=document.getElementById('dataCota').value || today();
    if(!pessoaId || valor<=0){ alert('Selecione a pessoa e informe um valor > 0'); return; }
    state.cotas.push({id:uid(), pessoaId, valor, data, ciclo:cicloDeData(data)});
    save();
    showToast('Cota lançada.');
  }
  if(t.dataset.delCota){
    if(!ensureNotLocked()) return;
    const id=t.dataset.delCota;
    const ok = await confirmDialog('Excluir este lançamento de cota?', 'Excluir cota');
    if(!ok) return;
    state.cotas=state.cotas.filter(c=>c.id!==id);
    save();
    showToast('Lançamento de cota removido.', true);
  }

  /* EMPRÉSTIMOS */
  if(t.id==='btnAddEmprestimo'){
    if(!ensureNotLocked()) return;
    const tomador=document.getElementById('emprestTomador').value.trim();
    const principal=Number(document.getElementById('emprestPrincipal').value||0);
    const percentual=Number(document.getElementById('emprestPercentual').value);
    const data=document.getElementById('emprestData').value || today();
    let venc=document.getElementById('emprestVenc').value;
    const status=document.getElementById('emprestStatus').value;

    if(!tomador || principal<=0){ alert('Informe o tomador e o principal (>0)'); return; }
    if(!venc) venc = addMonths(data,1);

    const idEmp = uid();
    state.emprestimos.push({
      id:idEmp,
      codigo:'EMP-'+String(state.seqEmprestimo++).padStart(4,'0'),
      tomador, principal, percentual, data, status, ciclos:1, extra:0, vencimento:venc
    });

    // Cashback 5% a partir de 250
    if (principal >= 250){
      const valorCb = Number((principal * 0.05).toFixed(2));
      state.cashbacks.push({ id: uid(), emprestimoId: idEmp, tomador, valor: valorCb, data });
      showToast('Cashback de '+fmt(valorCb)+' gerado para '+tomador+'.');
    }

    save();
  }

  if(t.dataset.closeEmp){
    if(!ensureNotLocked()) return;
    const eId=t.dataset.closeEmp;
    const emp=state.emprestimos.find(x=>x.id===eId);
    if(emp){
      emp.status = (emp.status==='aberto')?'fechado':'aberto';
      save();
    }
  }

  if(t.dataset.delEmp){
    if(!ensureNotLocked()) return;
    const id=t.dataset.delEmp;
    const ok = await confirmDialog('Excluir este empréstimo?', 'Excluir empréstimo');
    if(!ok) return;
    state.emprestimos=state.emprestimos.filter(x=>x.id!==id);
    state.retornos=state.retornos.filter(r=>r.emprestimoId!==id);
    state.cashbacks=state.cashbacks.filter(cb=>cb.emprestimoId!==id);
    save();
    showToast('Empréstimo removido.', true);
  }

  /* RETORNOS */
  if(t.id==='btnAddRetorno'){
    if(!ensureNotLocked()) return;
    const emprestimoId=document.getElementById('retornoEmprestimo').value;
    const valorTotal=Number(document.getElementById('retornoValor').value||0);
    const data=document.getElementById('retornoData').value || today();
    const tipo=document.getElementById('retornoTipo').value;

    if(!emprestimoId || valorTotal<=0){ alert('Selecione o empréstimo e um valor > 0'); return; }
    const emp=state.emprestimos.find(x=>x.id===emprestimoId);
    if(!emp){ alert('Empréstimo não encontrado.'); return; }

    const dAntes=devidoEmprestimo(emp);
    const jurosCiclo=jurosDoCiclo(emp);

    if(tipo==='juros'){
      state.retornos.push({id:uid(), emprestimoId, valor:valorTotal, data, tipo:'juros'});
      if(valorTotal + 0.009 >= jurosCiclo){
        emp.ciclos=Number(emp.ciclos||1)+1;
        emp.vencimento=addMonths(data,1);
        emp.status='aberto';
      }
      save();
      showToast('Retorno (juros) registrado.');
      return;
    }

    if(tipo==='principal'){
      state.retornos.push({id:uid(), emprestimoId, valor:valorTotal, data, tipo:'principal'});
      const restante = dAntes.total - (dAntes.pagos + valorTotal);
      if(restante > 0){
        const extra = restante * Number(emp.percentual);
        emp.extra = Number(emp.extra||0) + extra;
        emp.vencimento = addMonths(data,1);
        emp.status='aberto';
      }else{
        emp.status='fechado';
        emp.vencimento = data;
      }
      save();
      showToast('Retorno (principal) registrado.');
      return;
    }

    if(tipo==='misto'){
      const parteJuros = Math.min(valorTotal, jurosCiclo);
      const partePrincipal = Math.max(0, valorTotal - parteJuros);

      if(parteJuros>0) state.retornos.push({id:uid(), emprestimoId, valor:parteJuros, data, tipo:'juros'});
      if(parteJuros + 0.009 >= jurosCiclo){
        emp.ciclos=Number(emp.ciclos||1)+1;
        emp.vencimento=addMonths(data,1);
        emp.status='aberto';
      }

      if(partePrincipal>0){
        state.retornos.push({id:uid(), emprestimoId, valor:partePrincipal, data, tipo:'principal'});
        const restante = dAntes.total - (dAntes.pagos + parteJuros + partePrincipal);
        if(restante > 0){
          const extra = restante * Number(emp.percentual);
          emp.extra = Number(emp.extra||0) + extra;
          emp.vencimento = addMonths(data,1);
          emp.status='aberto';
        }else{
          emp.status='fechado';
          emp.vencimento=data;
        }
      }

      save();
      showToast('Retorno (misto) registrado.');
      return;
    }
  }

  if(t.dataset.delRet){
    if(!ensureNotLocked()) return;
    const id=t.dataset.delRet;
    const ok = await confirmDialog('Excluir este retorno?', 'Excluir retorno');
    if(!ok) return;
    state.retornos=state.retornos.filter(r=>r.id!==id);
    save();
    showToast('Retorno removido.', true);
  }

  /* PESSOAS */
  if(t.id==='btnAddPessoa'){
    if(!ensureNotLocked()) return;
    state.pessoas.push({id:uid(), nome:'Novo Nome'});
    save();
  }
  if(t.dataset.delPessoa){
    if(!ensureNotLocked()) return;
    const id=t.dataset.delPessoa;
    const ok = await confirmDialog('Remover este correntista?', 'Remover correntista');
    if(!ok) return;
    state.pessoas=state.pessoas.filter(p=>p.id!==id);
    state.cotas=state.cotas.filter(c=>c.pessoaId!==id);
    save();
    showToast('Correntista removido.', true);
  }
  if(t.id==='btnResetDados'){
    if(!ensureNotLocked()) return;
    if(confirm('Tem certeza? Isto apagará todos os dados (cotas, empréstimos, retornos, payouts, cashbacks).')){
      state.cotas=[];
      state.emprestimos=[];
      state.retornos=[];
      state.payouts=[];
      state.cashbacks=[];
      save();
    }
  }

  /* RESUMO/EXPORT */
  if(t.id==='btnAplicarFiltros') aplicarFiltros();
  if(t.id==='btnLimparFiltros'){
    document.getElementById('filtroDe').value='';
    document.getElementById('filtroAte').value='';
    document.getElementById('filtroTipo').value='todos';
    document.getElementById('filtroTomador').value='todos';
    document.getElementById('filtroCorrentista').value='todos';
    aplicarFiltros();
  }
  if(t.id==='btnExportResumoCSV') exportResumo('csv');
  if(t.id==='btnExportResumoXLS') exportResumo('xls');

  /* BAIXA FINAL */
  if(t.id==='btnGerarPayout') gerarTabelaPayout();
  if(t.id==='btnExportPayoutCSV'){ const ciclo=document.getElementById('cicloPayout').value; exportPayout(ciclo,'csv'); }
  if(t.id==='btnExportPayoutXLS'){ const ciclo=document.getElementById('cicloPayout').value; exportPayout(ciclo,'xls'); }

  if(t.dataset.payout){
    if(!ensureNotLocked()) return;
    const parts = t.dataset.payout.split('::');
    const pessoaId = parts[0], ciclo = parts[1], valor = parts[2];
    if (state.payouts.some(function(p){ return p.pessoaId === pessoaId && p.ciclo === ciclo; })) {
      alert('Baixa já registrada para essa pessoa neste ciclo.');
      return;
    }
    const data = today();
    state.payouts.push({id: uid(), pessoaId:pessoaId, ciclo:ciclo, valor: Number(valor), data:data});
    save();
    gerarTabelaPayout();
    showToast('Baixa registrada.');
  }

  if(t.dataset.estornar){
    if(!ensureNotLocked()) return;
    const parts = t.dataset.estornar.split('::');
    const pessoaId = parts[0], ciclo = parts[1];
    state.payouts = state.payouts.filter(function(p){ return !(p.pessoaId===pessoaId && p.ciclo===ciclo); });
    save();
    gerarTabelaPayout();
    showToast('Baixa estornada.', true);
  }

  /* BACKUP / IMPORT */
  if(t.id==='btnExportarBackup') exportBackup();
  if(t.id==='btnImportarBackup') document.getElementById('inputImportBackup').click();

  /* PIN */
  if(t.id==='btnDefinirPIN'){
    const elAtual=document.getElementById('pinAtual');
    const elNovo =document.getElementById('pinNovo');
    const atual=elAtual.value || '';
    const novo =elNovo.value || '';

    if(state.lock && state.lock.pin){
      if(atual!==state.lock.pin){
        showToast('PIN atual incorreto.', true);
        return;
      }
    }
    if(novo.length<4 || novo.length>10){
      showToast('PIN deve ter 4–10 dígitos.', true);
      return;
    }
    state.lock={pin:novo, locked:false};
    elAtual.value='';
    elNovo.value='';
    save();
    renderLockStatus();
    showToast('PIN atualizado.');
  }

  if(t.id==='btnBloquear'){
    if(!(state.lock && state.lock.pin)){
      showToast('Defina um PIN antes de bloquear.', true);
      return;
    }
    state.lock.locked=true;
    save();
    renderLockStatus();
    showToast('Bloqueado.');
  }

  if(t.id==='btnDesbloquear'){
    const elAtual=document.getElementById('pinAtual');
    const atual=elAtual.value || '';
    if(!(state.lock && state.lock.pin)){
      showToast('Sem PIN definido.', true);
      return;
    }
    if(atual!==state.lock.pin){
      showToast('PIN incorreto.', true);
      return;
    }
    state.lock.locked=false;
    save();
    renderLockStatus();
    showToast('Desbloqueado.');
  }

  /* SALVAR CICLO */
  if(t.id==='btnSalvarCfg'){
    if(!ensureNotLocked()) return;
    const ini=document.getElementById('cfgInicio').value;
    const fim=document.getElementById('cfgFim').value;
    if(!ini || !fim){ alert('Informe início e fim do ciclo.'); return; }
    state.config.inicio = ini;
    state.config.fim = fim;
    save();
    showToast('Ciclo atualizado.');
  }
});

/* input nome pessoa */
addEventListener('input', e=>{
  const t = e.target;
  if(t.dataset.pessoaNome){
    if(state.lock && state.lock.locked){
      const pOrig = state.pessoas.find(x=>x.id===t.dataset.pessoaNome);
      if(pOrig) t.value = pOrig.nome;
      return;
    }
    const p = state.pessoas.find(x=>x.id===t.dataset.pessoaNome);
    if(p) p.nome = t.value;
  }
});
addEventListener('focusout', e=>{
  const t = e.target;
  if(t.dataset.pessoaNome){ save(); }
});

/* retorno auto-preenchido */
['retornoEmprestimo','retornoTipo'].forEach(function(id){
  document.addEventListener('change', function(e){
    if(e.target.id!==id) return;
    const emprestimoId=document.getElementById('retornoEmprestimo').value;
    const tipo=document.getElementById('retornoTipo').value;
    const el=document.getElementById('retornoValor');
    const emp=state.emprestimos.find(x=>x.id===emprestimoId);
    if(!emp){ el.value=''; return; }
    const d=devidoEmprestimo(emp);
    const outstanding=Math.max(0, d.total - d.pagos);
    const juros=jurosDoCiclo(emp);
    if(tipo==='juros') el.value=Math.min(juros, outstanding).toFixed(2);
    else if(tipo==='misto') el.value=outstanding.toFixed(2);
    else el.value=Math.min(Number(emp.principal), outstanding).toFixed(2);
  });
});

/* export resumo */
function exportResumo(mode){
  if(!lastResumoRows || !lastResumoRows.length){
    alert('Nenhum movimento filtrado para exportar.');
    return;
  }
  if(mode==='csv'){
    const header = ['Data','Tipo','Descrição','Valor'];
    const csv = [header.join(';')].concat(
      lastResumoRows.map(function(r){
        return [ r.data, r.tipo.replace(/;/g,','), r.desc.replace(/;/g,','), (Number(r.valor)||0).toFixed(2).replace('.',',') ].join(';');
      })
    ).join('\n');
    download('resumo_movimentos.csv', csv, 'text/csv;charset=utf-8;');
  }else{
    const rows = lastResumoRows.map(function(r){
      return '<tr><td>'+r.data+'</td><td>'+r.tipo+'</td><td>'+r.desc+'</td><td>'+((Number(r.valor)||0).toFixed(2))+'</td></tr>';
    }).join('');
    const table = '<table border="1"><tr><th>Data</th><th>Tipo</th><th>Descrição</th><th>Valor</th></tr>'+rows+'</table>';
    download('resumo_movimentos.xls', table, 'application/vnd.ms-excel');
  }
}

/* ===== Init ===== */
function init(){
  setupTabs();

  setTheme(getTheme());

  setText('buildVersion', APP_VERSION);
  setText('footerVersion', APP_VERSION);
  setBadgeState('badgeVersion', 'ok');

  updateNetStatus();
  updateStorageStatus();
  updateImportStatus();
  updateBackupStatus();

  window.addEventListener('online', updateNetStatus);
  window.addEventListener('offline', updateNetStatus);

  document.getElementById('emprestData').value = today();
  document.getElementById('emprestVenc').value = addMonths(today(),1);
  document.getElementById('retornoData').value = today();
  document.getElementById('cfgInicio').value = state.config.inicio;
  document.getElementById('cfgFim').value = state.config.fim;

  document.getElementById('cotistaSelect').addEventListener('change', renderCotas);

  const importInput = document.getElementById('inputImportBackup');
  importInput.addEventListener('change', (ev)=>{
    const file = ev.target.files && ev.target.files[0];
    if(file) importBackup(file);
    ev.target.value = '';
  });

  renderAll();
  aplicarFiltros();
  renderLockStatus();
  showTab('tab-lancamentos');
}
init();
</script>
</body>
</html>
